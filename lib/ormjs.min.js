var ormjs={initialize:function(_callback){ormjs.models={},ormjs.highest_model_id=0,ormjs.object_kinds=["view","constraint","entity","value","connector","rolebox","predicate"],ormjs.tolerance={link:{},snap:{}},ormjs.default_dragevent=["bottom","right","top","left"],ormjs.display={shortFormat:!0,graphFormat:!1},ormjs.initialize_global_sizes(),ormjs.SVG.load_page(_callback)},initialize_global_sizes:function(){ormjs.size={entity:{height:ormjs.GraphUtils.get_css_number("--ojs-entity-height")},value:{height:ormjs.GraphUtils.get_css_number("--ojs-entity-height")},rolebox:{height:ormjs.GraphUtils.get_css_number("--ojs-rolebox-height"),width:ormjs.GraphUtils.get_css_number("--ojs-rolebox-width")},constraint:{radius:ormjs.GraphUtils.get_css_number("--ojs-constraint-radius"),oradius:ormjs.GraphUtils.get_css_number("--ojs-constraint-oradius"),stroke:ormjs.GraphUtils.get_css_number("--ojs-stroke-width")},connector:{wide_stroke:ormjs.GraphUtils.get_css_number("--ojs-stroke-width-wide"),stroke:ormjs.GraphUtils.get_css_number("--ojs-stroke-width")},view:{scale:ormjs.GraphUtils.get_css_number("--ojs-svg-scale"),scale_min:ormjs.GraphUtils.get_css_number("--ojs-svg-scale-min"),scale_max:ormjs.GraphUtils.get_css_number("--ojs-svg-scale-max")},popup:{width:ormjs.GraphUtils.get_css_number("--ojs-pop-width"),height:ormjs.GraphUtils.get_css_number("--ojs-pop-height"),stroke:ormjs.GraphUtils.get_css_number("--ojs-pop-stroke"),hover_stroke:ormjs.GraphUtils.get_css_number("--ojs-pop-stroke-hover"),close:ormjs.GraphUtils.get_css_number("--ojs-pop-close-sz"),check:{x:ormjs.GraphUtils.get_css_number("--ojs-pop-ch-width"),y:ormjs.GraphUtils.get_css_number("--ojs-pop-ch-height"),m:ormjs.GraphUtils.get_css_number("--ojs-pop-ch-marg")}}}},Model:class{id;objects={};currentview=null;metamodel;rel_target=null;xml_target=null;generate_xml=!1;generate_rel=!0;dragevent={locations:["bottom","right","top","left"],all_locations:["bottom","right","top","left"]};constructor(data){0<arguments.length?(data.id?this.id=data.id:this.modelID(),"objects"in data?(this.objects=data.objects,this.initialize_tolerance(),this.initialize_metamodel()):this.initialize()):(this.modelID(),this.initialize()),this.record()}modelID(){var objID="ormjsid-model-"+ormjs.highest_model_id;ormjs.highest_model_id+=1,this.id=objID}record(){ormjs.models[this.id]=this}initialize(){this.initialize_objects(),this.initialize_tolerance(),this.initialize_metamodel()}initialize_metamodel(){this.metamodel=new ormjs.Metamodel(this.id)}initialize_objects(){ormjs.object_kinds.map(name=>{this.objects[name]={},this.objects[`highest_${name}_id`]=0})}initialize_tolerance(){ormjs.tolerance.link={entity:2*ormjs.size.entity.height,value:2*ormjs.size.value.height,rolebox:ormjs.size.rolebox.width,constraint:ormjs.size.constraint.oradius,connector:ormjs.size.connector.wide_stroke},ormjs.tolerance.snap={entity:2*ormjs.size.entity.height/15,value:2*ormjs.size.value.height/15,rolebox:ormjs.size.rolebox.width/10,predicate:ormjs.size.rolebox.width/10,constraint:ormjs.size.constraint.radius/5}}set_current_view(viewID){this.currentview=this.objects.view[viewID]}populate_metamodel(){this.initialize_metamodel(),this.metamodel.populate()}update(){this.populate_metamodel(),this.generate_rel&&(ormjs.GenerateRel.parse(this.metamodel),ormjs.GenerateRel.display_rel(this)),this.generate_xml&&this.metamodel.display_xml(),ormjs.Graph.add_shadows(this.metamodel)}static generateID(modelID,kind){var objID=`ormjsid-${kind}-`+ormjs.models[modelID].objects[`highest_${kind}_id`];return ormjs.models[modelID].objects[`highest_${kind}_id`]+=1,objID}},SVG:class{static download(viewID,URItarget){ormjs.PropertyMenu.remove_all_popups(viewID,()=>console.log("Popups removed."));var modelID=ormjs.Graph.any_object(viewID).model,modelID=(ormjs.SVG.jsonify(modelID),ormjs.InlineStyle.add(viewID),ormjs.SVG.set_svg_dimensions(viewID),(new XMLSerializer).serializeToString(d3.select("#"+viewID).node())),modelID="data:image/svg+xml;base64,"+ormjs.SVG.utoa(modelID);return 1<arguments.length&&d3.select("#"+URItarget).attr("href",modelID),ormjs.InlineStyle.remove(viewID),ormjs.SVG.unset_svg_dimensions(viewID),modelID}static utoa(data){return btoa(unescape(encodeURIComponent(data)))}static jsonify(modelID){var objects=ormjs.models[modelID].objects;ormjs.object_kinds.map(kind=>{for(var objID in objects[kind])objects[kind][objID].d3object.attr("json",JSON.stringify(objects[kind][objID].d3object.datum()))})}static set_svg_dimensions(viewID){var svgparent=ormjs.GraphUtils.parent_node_id(viewID),cnvsw=document.getElementById(svgparent).offsetWidth,svgparent=document.getElementById(svgparent).offsetHeight;d3.select("#"+viewID).attr("width",cnvsw).attr("height",svgparent)}static unset_svg_dimensions(viewID){d3.select("#"+viewID).attr("width","100%").attr("height","100%")}static upload(file,target_view,_callback){var reader=new FileReader;reader.readAsText(file),reader.onload=function(event){event=event.target.result;ormjs.SVG.to_view(target_view,event),ormjs.Graph.model_from_id(target_view).update(),_callback()},reader.onerror=error=>console.log(error)}static to_view(viewID,data){var oid,view=ormjs.Graph.any_object(viewID),refmap=(view.clear(),data=data.replaceAll("ormjsid","ormjsnid"),d3.select("#"+view.parent).html(data),ormjs.SVG.create_model_ids_from_view(view)),svgid=d3.select("#"+view.parent).selectAll(".ormjs-svg_prototype").nodes()[0].id,svgid=(refmap[svgid]=view.id,view.d3object.datum(JSON.parse(d3.select("#"+svgid).attr("json"))),view.d3object.datum());for(oid in refmap[svgid.model]=view.model,refmap[svgid.parent]=view.parent,refmap)data=data.replaceAll(oid,refmap[oid]);d3.select("#"+view.parent).html(data),view.d3object=d3.select("#"+view.id),view.d3object.datum(JSON.parse(view.d3object.attr("json"))),view.actions(),view.update_svgscale(),ormjs.SVG.unset_svg_dimensions(viewID),ormjs.InlineStyle.remove(view.id),ormjs.SVG.populate_model_from_view(view)}static create_model_ids_from_view(view){var class_kind={connector_prototype:"connector",predicate_prototype:"predicate",constraint_prototype:"constraint",entity_prototype:"entity",value_prototype:"value"},refmap={};return["connector_prototype","predicate_prototype","constraint_prototype","entity_prototype","value_prototype"].map(cls=>{var k,object_divs=d3.select("#"+view.parent).selectAll(".ormjs-"+cls);for(k in object_divs.nodes()){var anyID=object_divs.nodes()[k].id;refmap[anyID]=ormjs.Model.generateID(view.model,class_kind[cls])}}),refmap}static populate_model_from_view(view){["connector_prototype","rolebox_prototype","predicate_prototype","constraint_prototype","entity_prototype","value_prototype"].map(cls=>{ormjs.SVG.populate_class(view,cls)})}static populate_class(view,class_name){var k,object_divs=d3.select("#"+view.parent).selectAll(".ormjs-"+class_name);for(k in object_divs.nodes()){var anyID=object_divs.nodes()[k].id,anyID=d3.select("#"+anyID);anyID.datum(JSON.parse(anyID.attr("json"))),"connector_prototype"==class_name&&new ormjs.Connector({d3object:anyID}).record(),"constraint_prototype"==class_name&&new ormjs.Constraint({d3object:anyID}),"entity_prototype"==class_name&&new ormjs.Entity({d3object:anyID}),"value_prototype"==class_name&&new ormjs.Value({d3object:anyID}),"predicate_prototype"==class_name&&new ormjs.Predicate({d3object:anyID}),"rolebox_prototype"==class_name&&new ormjs.Rolebox({d3object:anyID})}}static load_page(_callback){d3.select("body").selectAll(".ormjs-svg_prototype").nodes().map(obj=>obj.id).map(viewID=>{var model,view,parentID=d3.select(d3.select("#"+viewID).node().parentNode).node().id,data=d3.select("#"+parentID).html(),d=JSON.parse(d3.select("#"+viewID).attr("json"));d.model in ormjs.models||(model=new ormjs.Model({id:d.model})),viewID in ormjs.models[model.id].objects.view&&parentID==(view=ormjs.models[model.id].objects.view[viewID]).parent||(view=new ormjs.View({model:model.id,parent:parentID})),ormjs.SVG.to_view(view.id,data),ormjs.models[view.model].update()}),null!=_callback&&_callback()}},InlineStyle:class{static remove(viewID){var dv,idlist=document.getElementById(viewID).querySelectorAll("[id]");for(dv in idlist)idlist[dv].id&&d3.select("#"+idlist[dv].id).attr("style",null)}static add(viewID){var dv,idlist=document.getElementById(viewID).querySelectorAll("[id]"),support=ormjs.InlineStyle.supported();for(dv in idlist){var n=idlist[dv];n.id&&(d3.select("#"+n.id).attr("style",()=>ormjs.InlineStyle.dumpCSSText(n.id,support)),n.id.includes("r-ormjsid-entity")&&ormjs.InlineStyle.add_shape_style(n.id),n.id.includes("r-ormjsid-value")&&ormjs.InlineStyle.add_shape_style(n.id),n.id.includes("c-ormjsid-constraint")&&ormjs.InlineStyle.add_shape_style(n.id))}}static supported(){return["filter","fill","cursor","opacity","stroke","stroke-width","stroke-dasharray","height","width","rx","ry","r","font-family","font-size","paint-order","color","dominant-baseline","text-anchor"]}static dumpCSSText(anyID,support){var anyID=document.getElementById(anyID),o=window.getComputedStyle(anyID),s="";if(2==arguments.length)for(var i in o)support.includes(o[i])&&(s+=o[i]+":"+o.getPropertyValue(o[i])+";");else for(var i in o)s+=o[i]+":"+o.getPropertyValue(o[i])+";";return s}static add_shape_style(anyID){var i,stylelist=["rx","ry","fill","opacity","height","stroke-dasharray"],elem=document.getElementById(anyID),o=window.getComputedStyle(elem),obj=d3.select("#"+anyID);for(i in o)stylelist.includes(o[i])&&obj.attr(o[i],o.getPropertyValue(o[i]))}},GenerateRel:class{static update(modelID){modelID=ormjs.models[modelID];modelID.populate_metamodel(),ormjs.GenerateRel.parse(modelID.metamodel),ormjs.GenerateRel.display_rel(modelID)}static parse(metamodel){ormjs.GenerateRel.metamodel_rel_names(metamodel),ormjs.GenerateRel.add_rel_readings(metamodel);var viewID,views=ormjs.models[metamodel.model].objects.view;for(viewID in views)ormjs.RelHighlighter.highlight(views[viewID])}static metamodel_rel_names(metamodel){for(var objID in metamodel.Object)ormjs.GenerateRel.set_relname(metamodel.Object[objID]);for(var factID in metamodel.Fact)metamodel.Fact[factID].FactRoles.map(role=>{ormjs.GenerateRel.set_relname(role,"role")}),metamodel.Fact[factID].ReadingOrder.map(ro=>{ormjs.GenerateRel.set_relname(ro,"reading-order")})}static set_relname(obj){"EntityType"==obj.type?(obj._RelName=ormjs.GenerateRel.entity_relname(obj.Name),obj._Atom=ormjs.GenerateRel.entity_atom_relname(obj._RelName,obj.ReferenceMode)):"ValueType"==obj.type?(obj._RelName=ormjs.GenerateRel.entity_relname(obj.Name),obj._Atom=ormjs.GenerateRel.value_atom_relname(obj.Name)):"Role"==obj.type?obj._RelName=ormjs.GenerateRel.role_relname(obj.Name):"ReadingOrder"==obj.type&&(obj._RelName=ormjs.GenerateRel.reading_order_relname(obj))}static entity_relname(name){return name.trim().split(" ").filter(e=>e).join("").replaceAll("-","_").replaceAll(":","")}static entity_atom_relname(name,refmode){return name.toLowerCase()+"_"+refmode.trim().split("_")[0].replaceAll("-","_").replaceAll(":","")}static value_atom_relname(name){return name.trim().split(" ")[0].substring(0,3).toLowerCase().replaceAll("-","_").replaceAll(":","")}static role_relname(name){return name.trim().split(" ").filter(e=>e).join("_").replaceAll("-","_").replaceAll(":","")}static reading_order_relname(ro){var c=ormjs.display.graphFormat?":":"_",metamodel=ormjs.models[ro.model].metamodel,factID=ro._factID,boxes=ro.RoleSequence,factroles=metamodel.Fact[factID].FactRoles;if(1==boxes.length){if(null==factroles[boxes[0]].RolePlayer)return!1;var rplayer=metamodel.Object[factroles[boxes[0]].RolePlayer]._RelName,ro=metamodel.Fact[factID].FactRoles[boxes[0]]._RelName;return ormjs.display.graphFormat||!ormjs.display.shortFormat?""+rplayer+c+ro:ro}var inclEntity=!0,inclBox=!0,relname=(ormjs.display.shortFormat&&ormjs.display.graphFormat?inclBox=!1:ormjs.display.shortFormat&&!ormjs.display.graphFormat&&(inclEntity=!1),"");if(null==factroles[boxes[0]].RolePlayer)return!1;rplayer=metamodel.Object[factroles[boxes[0]].RolePlayer]._RelName;if(inclEntity&&(relname=""+rplayer),inclBox&&(inclEntity&&(relname+=""+c),relname+=""+metamodel.Fact[factID].FactRoles[boxes[0]]._RelName),0<metamodel.Fact[factID].FactRoles[boxes[1]]._RelName.length&&inclBox&&(relname+="_"+metamodel.Fact[factID].FactRoles[boxes[1]]._RelName),null==factroles[boxes[1]].RolePlayer)return!1;rplayer=metamodel.Object[factroles[boxes[1]].RolePlayer]._RelName,inclEntity&&(relname+=""+c+rplayer);var n,rng=ormjs.GraphUtils.range(boxes.length-2,2);for(n in rng){if(inclBox&&(relname+=""+c+metamodel.Fact[factID].FactRoles[boxes[rng[n]]]._RelName),null==factroles[boxes[rng[n]]].RolePlayer)return!1;rplayer=metamodel.Object[factroles[boxes[rng[n]]].RolePlayer]._RelName,inclEntity&&(relname+=""+c+rplayer)}return relname}static add_rel_readings(metamodel){for(var factID in metamodel.Fact)metamodel.Fact[factID].ReadingOrder.map(ro=>{ro.Reading.map(reading=>{reading.set_rel_reading()})}),metamodel.Fact[factID].fill_readings()}static add_NaryForwardReading(reading){var id,relcode,metamodel=ormjs.models[reading.model].metamodel,factID=reading._factID,ronum=reading._ronum,relname=metamodel.Fact[factID].ReadingOrder[ronum]._RelName;relname&&(id=ormjs.display.graphFormat?":id":"",ronum=metamodel.Fact[factID].ReadingOrder[ronum].RoleSequence.map(e=>`{${e}}`+id).join(", "),relcode=[],1<metamodel.Fact[factID]._Shadows.length?(relcode.push(`ic { ${relname} ⊆ ${metamodel="allowed_"+relname} }`),relcode.push(`@inline def ${metamodel} = (${ronum})`)):relcode.push(`ic { ${relname} ⊆ (${ronum}) }`),reading._RelData=relcode)}static add_MandatoryForwardReading(reading){var id,relstring,metamodel=ormjs.models[reading.model].metamodel,rolen=reading.ExpandedData[0].RoleIndex,relname=metamodel.Fact[reading._factID].ReadingOrder[reading._ronum]._RelName;relname&&(id=ormjs.display.graphFormat?":id":"",relstring="",relstring=2==(metamodel=metamodel.Fact[reading._factID].ReadingOrder[reading._ronum].RoleSequence.length)?0==rolen?`ic { total({${rolen}}${id}, ${relname}) }`:`ic { total({${rolen}}${id}, transpose[${relname}]) }`:`ic { {${rolen}}${id}(${id=`{a${rolen}}`}) implies ${relname}(${"_,".repeat(rolen)+id+",_".repeat(metamodel-rolen-1)}) }`,reading._RelData=[relstring])}static generate_codeblock(model){var objID,code_group={},fact_groups=ormjs.GenerateRel.facts_by_entity(model.metamodel);for(objID in fact_groups)code_group[objID]={},fact_groups[objID].facts.map(ro=>{ro.Reading.map(reading=>{null!=reading._Statement&&(code_group[objID][reading._Statement]=reading._RelStatement)})});return code_group}static flatten_codeblock(code_group,model){var objID,statements=[];for(objID in code_group)for(var sentence in code_group[objID])0<code_group[objID][sentence].length&&(statements.push(`/* ${model.metamodel.Object[objID].Name} */`),statements.push("// "+sentence),statements.push.apply(statements,code_group[objID][sentence]));return statements=statements.filter(function(item,pos){return statements.indexOf(item)==pos})}static display_rel(model){var code_block=ormjs.GenerateRel.generate_codeblock(model),code_block=(code_block=ormjs.GenerateRel.flatten_codeblock(code_block,model).join("\n")).replaceAll("\n/*","\n\n/*").replaceAll("*/\n","*/\n\n");return null!=model.rel_target&&null!=d3.select("#"+model.rel_target)&&d3.select("#"+model.rel_target).html(`<pre><code class="language-js">${code_block}</code></pre>`),code_block}static facts_by_entity(metamodel){var factID,fact_groups={};for(factID in metamodel.Fact)metamodel.Fact[factID].ReadingOrder.map(ro=>{var objID=ro._FirstEntity;null!=objID&&(objID in fact_groups?fact_groups[objID].facts.push(ro):fact_groups[objID]={facts:[ro]})});return fact_groups}},RelHighlighter:class{static highlight(view){var boxID,in_view=view.objects_in_view(),objects=ormjs.models[view.model].objects;for(boxID in["entity","value","connector","rolebox","constraint"].map(obj=>{for(var objID in objects[obj])in_view.includes(ormjs.Graph.get_parentID(objID))&&ormjs.RelHighlighter.class_as_notparsed(objID,view)}),objects.rolebox)in_view.includes(ormjs.Graph.get_parentID(boxID))&&ormjs.RelHighlighter.class_as_notparsed("c-"+boxID,view)}static class_as_notparsed(anyID,view){ormjs.Graph.unclass_as(anyID,"ormjs-notparsed"),!ormjs.models[view.model].metamodel.relIDs.includes(anyID)&&view.highlight&&ormjs.Graph.class_as(anyID,"ormjs-notparsed")}},Graph:class{static object_move(object){var d=object.d3object.datum();object.d3object.attr("x",d.x).attr("y",d.y).attr("transform",()=>ormjs.Graph.translate(d.dx,d.dy)),ormjs.Connector.redraw(d.connectors)}static dragstarted(event,d){event.sourceEvent.stopPropagation();event=ormjs.Graph.any_object(d.id);return event.d3object.datum().selected=!0,event.d3object.style("cursor","grabbing"),event}static dragged(event,d){var object=ormjs.Graph.any_object(d.id);object.d3object.classed("ormjs-selected")?ormjs.HighlightRegion.drag_selected(event):(d.dx+=event.dx,d.dy+=event.dy,d.dx=ormjs.Graph.snap(d.dx+d.x0,"x",object.id)-d.x0,d.dy=ormjs.Graph.snap(d.dy+d.y0,"y",object.id)-d.y0,d.x=d.x0+d.dx,d.y=d.y0+d.dy,object.move(),"predicate"==object.kind&&object.position_boxes())}static dragended(event,d){d=ormjs.Graph.any_object(d.id);return d.d3object.datum().selected=!1,d.d3object.style("cursor","grab"),d}static mousedown(event,object,mousepos){var pos,conn;event.stopPropagation(),2!=event.buttons&&(event=ormjs.Connector.supported_types().names,mousepos={x1:(pos=object.closest_overlay(mousepos)).x,x2:mousepos.x,y1:pos.y,y2:mousepos.y,model:object.model},"constraint"==object.kind&&(mousepos.conntype=event.CtoRB),"rolebox"==object.kind&&((event=ormjs.models[object.model].dragevent).locations=["top","bottom"],event.locations.includes(pos.location)||(event.locations=[pos.location])),(event=(conn=new ormjs.Connector(mousepos)).d3object.datum()).from=object.id,event.selected=!0,d3.select("#"+object.view).on("mousemove",function(event){conn.svg_mousemove(event)}).on("mouseup",function(event){conn.svg_mouseup(event)}))}static remove(event){event.stopPropagation(),!event.ctrlKey&&2!=event.buttons||(event=ormjs.Graph.get_parentID(event.target.id.toString()),null!=(event=ormjs.Graph.any_object(event))&&event.delete())}static delete_object(object){var d=object.d3object.datum(),conns=[...d.connectors],model=ormjs.models[object.model];conns.map(connID=>{model.objects.connector[connID].delete()}),object.d3object.transition().duration(400).attr("transform","translate("+d.x+","+d.y+") scale(0)").remove(),d3.select("#pop-"+object.id).empty()||remove_popup(d3.select("#pop-"+object.id)),delete model.objects[object.kind][object.id],model.update()}static model_from_id(anyID){anyID=d3.select("#"+anyID).datum();return ormjs.models[anyID.model]}static any_object(anyID){var d=d3.select("#"+anyID).datum();if(!d)return null;d=ormjs.models[d.model].objects[d.kind];return anyID in d?d[anyID]:null}static closest_overlay(position,anyID,locations=ormjs.default_dragevent){return ormjs.Graph.any_object(anyID).closest_overlay(position,locations)}static closest_location(position,xyo,locations=ormjs.default_dragevent){var closestDistance=Number.MAX_VALUE,closestLocation="right";return locations.map(location=>{xyo[location].distance=Math.sqrt(Math.pow(position.x-xyo[location].x,2)+Math.pow(position.y-xyo[location].y,2)),xyo[location].distance<closestDistance&&(closestDistance=xyo[location].distance,closestLocation=location)}),xyo[closestLocation]}static closest_object(position,modelID){var objects=ormjs.models[modelID].objects,objinfo={object:null,distance:Number.MAX_VALUE,tolerance:0,found:!1},modelID=(["entity","rolebox","value","constraint"].map(obj=>{objinfo=ormjs.Graph.closest_of_kind(position,objinfo,objects[obj])}),ormjs.Connector.all_subtypes(modelID));return(objinfo=ormjs.Graph.closest_of_kind(position,objinfo,modelID)).tolerance=objinfo.object?ormjs.tolerance.link[objinfo.object.datum().kind]:0,objinfo}static closest_of_kind(position,objinfo,objdic){for(var anyID in objdic){var distance,anyID=d3.select("#"+anyID);(distance=ormjs.Graph.position_distance(position,anyID.datum()))<objinfo.distance&&(objinfo.distance=distance,objinfo.object=anyID,objinfo.found=!0)}return objinfo}static position_distance(pos1,pos2){return void 0!==pos2.x?Math.sqrt(Math.pow(pos1.x-pos2.x,2)+Math.pow(pos1.y-pos2.y,2)):ormjs.Geometry.closest_on_line(pos1,pos2).distance}static snap(pos,field,anyID){var objects=ormjs.Graph.model_from_id(anyID).objects,closest={object:null,distance:Number.MAX_VALUE},field_suff="",tolerance_anyID=(["entity","value","rolebox","predicate"].map(obj=>{var f=field,f=("predicate"==obj&&(f+="c"),ormjs.Graph.closest_object_1D(anyID,objects[obj],f,pos));f.distance<closest.distance&&(closest=f,"predicate"==obj&&(field_suff="c"))}),ormjs.tolerance.snap[ormjs.Graph.object_kind(anyID)]);return closest.distance<tolerance_anyID?closest.object.datum()[field+field_suff]:pos}static closest_object_1D(myobjID,objects,field,ideal){var objID,closest={object:null,distance:Number.MAX_VALUE};for(objID in objects){var distance,candidateObject=d3.select("#"+objID);objID==myobjID||myobjID==candidateObject.attr("parent")||(distance=Math.abs(candidateObject.datum()[field]-ideal))<closest.distance&&(closest.object=candidateObject,closest.distance=distance)}return closest}static overlay_positions(object){var x=object.d3object.datum().x,y=object.d3object.datum().y,width=parseInt(object.d3object.attr("width")),object=parseInt(object.d3object.attr("height"));return{bottom:{x:x,y:y+object/2,location:"bottom"},right:{x:x+width/2,y:y,location:"right"},top:{x:x,y:y-object/2,location:"top"},left:{x:x-width/2,y:y,location:"left"}}}static rotated_overlay_positions(object){var x=object.d3object.datum().x,y=object.d3object.datum().y,width=parseInt(object.d3object.attr("width")),object=parseInt(object.d3object.attr("height"));return{bottom:{x:x-object/2,y:y,location:"bottom"},right:{x:x,y:y+width/2,location:"right"},top:{x:x+object/2,y:y,location:"top"},left:{x:x,y:y-width/2,location:"left"}}}static plays_lead_roles(object){return ormjs.Graph.plays_roles(object).map(roleID=>{roleID=d3.select("#"+roleID).datum().parent;if(d3.select("#"+roleID).datum().entity_in==object.id)return roleID}).filter(v=>v)}static plays_roles(object){return object.d3object.datum().connectors.map(connID=>{connID=d3.select("#"+connID).datum();if("rolebox"==ormjs.Graph.object_kind(connID.to))return connID.to}).filter(v=>v)}static object_kind(anyID){return anyID.includes("conn")?"connector":anyID.includes("entity")?"entity":anyID.includes("value")?"value":anyID.includes("constraint")?"constraint":anyID.includes("predicate")&&anyID.includes("r-")&&!anyID.includes("r-r-")?"rolebox":anyID.includes("predicate")?"predicate":""}static change_id(d3object,new_id){var n,replace_id,child_nodes=d3object.node().childNodes,root_id=d3object.attr("id");for(n in child_nodes)child_nodes[n].id&&(replace_id=child_nodes[n].id.replaceAll(root_id,new_id),d3.select("#"+child_nodes[n].id).attr("id",replace_id));d3object.attr("id",new_id),d3object.datum().id=new_id}static object_number(anyID){return anyID.split("-")[2]}static draw_overlay(object,oclass){var width=parseInt(object.attr("width")),height=parseInt(object.attr("height")),d=object.datum(),pd=d3.select("#"+object.attr("parent")).datum(),overlayID="o-"+object.attr("id"),x=("predicate"==pd.kind&&(height*=1.5),pd.x0+d.dx),y=pd.y0,d=object.append("g").attr("id",overlayID).attr("class","ormjs-overlay_prototype").attr("width",width).attr("height",height).attr("x",0).attr("y",0).attr("transform",()=>ormjs.Graph.overlay_translate(x,y,width,height));return d.append("circle").attr("class","ormjs-overlay "+oclass).attr("transform",()=>ormjs.Graph.translate(width/2,0)),d.append("circle").attr("class","ormjs-overlay "+oclass).attr("transform",()=>ormjs.Graph.translate(width,height/2)),d.append("circle").attr("class","ormjs-overlay "+oclass).attr("transform",()=>ormjs.Graph.translate(width/2,height)),d.append("circle").attr("class","ormjs-overlay "+oclass).attr("transform",()=>ormjs.Graph.translate(0,height/2)),d}static overlay_translate(x,y,width,height){return"translate( "+(x-width/2)+","+(y-height/2)+" )"}static object_width(object){var width,d=object.d3object.datum(),height=(width="entity"==d.kind?Math.max(ormjs.Entity.name_width(d.name),ormjs.Entity.name_width(d.refmode)):ormjs.Entity.name_width(d.name),parseInt(object.d3object.attr("height")));object.d3object.attr("width",width),object.update_overlay(),d3.select("#r-"+object.id).attr("width",width).attr("transform",()=>ormjs.Graph.translate(-width/2,-height/2)),ormjs.Connector.redraw(d.connectors)}static overlay_width(object){d3.select("#o-"+object.id).remove();var d=object.d3object.datum(),ov=d.kind.substring(0,1)+"overlay";ormjs.Graph.draw_overlay(object.d3object,ov).attr("transform",()=>ormjs.Graph.overlay_translate(d.x0,d.y0,parseInt(object.d3object.attr("width")),parseInt(object.d3object.attr("height")))),object.overlay_actions()}static fill_datum(d,def_d){var attr,fin_d=def_d;for(attr in fin_d)null!=d[attr]&&(fin_d[attr]=d[attr]);return fin_d}static translate(x,y){return"translate( "+x+","+y+" )"}static translate_rotate(x0,y0,x,y){return"rotate(90, "+x0+", "+y0+") translate("+x+", "+y+")"}static get_parentID(anyID){var anyID=anyID.split("-"),len=anyID.length;return anyID[len-3]+"-"+anyID[len-2]+"-"+anyID[len-1]}static levelupID(anyID){anyID=anyID.split("-");return anyID.slice(1,anyID.length).join("-")}static add_shadows(metamodel){var factID,objID,shadows,objects=ormjs.models[metamodel.model].objects;for(objID in objects.predicate)ormjs.Graph.unclass_as(objID,"ormjs-shadowed");for(factID in metamodel.Fact)if(1<(shadows=metamodel.Fact[factID]._Shadows).length)for(var n in shadows)ormjs.Graph.class_as(shadows[n],"ormjs-shadowed");for(objID in objects.entity)ormjs.Graph.unclass_as(objID,"ormjs-shadowed");for(objID in objects.value)ormjs.Graph.unclass_as(objID,"ormjs-shadowed");for(objID in metamodel.Object)if(1<(shadows=metamodel.Object[objID]._Shadows).length)for(var n in shadows)ormjs.Graph.class_as(shadows[n],"ormjs-shadowed")}static unclass_as(anyID,cname){var class_string=d3.select("#"+anyID).attr("class");d3.select("#"+anyID).attr("class",class_string.replaceAll(" "+cname,""))}static class_as(anyID,cname){var class_string=d3.select("#"+anyID).attr("class");ormjs.Graph.unclass_as(anyID,cname),d3.select("#"+anyID).attr("class",class_string+" "+cname)}},GraphUtils:class{static remove_from_array(arr,v){v=arr.indexOf(v);return-1<v&&arr.splice(v,1),arr}static key_from_value(obj,value){return Object.keys(obj).find(key=>obj[key]===value)}static range(size,startAt=0){return[...Array(size).keys()].map(i=>i+startAt)}static get_css_variable(varname){return window.getComputedStyle(document.documentElement).getPropertyValue(varname)}static parse_number(mystring){return parseInt(mystring.replace(/\D/g,""))}static get_css_number(varname){return ormjs.GraphUtils.parse_number(ormjs.GraphUtils.get_css_variable(varname))}static parent_node_id(id){return d3.select(d3.select("#"+id).node().parentNode).node().id}},Geometry:class{static resize_and_rotate(pos){var totallen=Math.sqrt(Math.pow(pos.x1-pos.x2,2)+Math.pow(pos.y1-pos.y2,2)),transform_string="translate("+pos.x1+" "+pos.y1+")",totalangle=180*Math.atan((pos.y2-pos.y1)/(pos.x2-pos.x1))/Math.PI;return pos.x1>pos.x2&&(totalangle+=180),{transform:transform_string+=" rotate("+totalangle+")",length:totallen}}static line_midpoint(pos){return{x:(pos.x2-pos.x1)/2+pos.x1,y:(pos.y2-pos.y1)/2+pos.y1}}static closest_on_line(pos,linepos){var m=(linepos.y2-linepos.y1)/(linepos.x2-linepos.x1),b=linepos.y1-m*linepos.x1,pm=-1/m,pm=(pos.y-pos.x*pm-b)/(m-pm),m=ormjs.Geometry.position_in_box({x:pm,y:m*pm+b},linepos),pm=Math.sqrt(Math.pow(pos.x-m.x,2)+Math.pow(pos.y-m.y,2));return{x:m.x,y:m.x,distance:pm}}static position_in_box(pos,boxpos){var minx=Math.min(boxpos.x1,boxpos.x2),maxx=Math.max(boxpos.x1,boxpos.x2),minx=(pos.x=Math.max(minx,pos.x),pos.x=Math.min(maxx,pos.x),Math.min(boxpos.y1,boxpos.y2)),maxx=Math.max(boxpos.y1,boxpos.y2);return pos.y=Math.max(minx,pos.y),pos.y=Math.min(maxx,pos.y),pos}static point_on_circle(pos){var totalangle=Math.atan((pos.y2-pos.y1)/(pos.x2-pos.x1));return pos.x1>pos.x2&&(totalangle+=Math.PI),{x:pos.x1+pos.r*Math.cos(totalangle),y:pos.y1+pos.r*Math.sin(totalangle)}}},View:class{d3object;id;model;parent;kind="view";traversal=!1;traversal_target=null;highlight=!1;constructor(data){var d;data.d3object?(d=data.d3object.datum(),data.model?(this.model=data.model,this.id=ormjs.View.generateID(this.model)):(this.model=d.model,this.id=d.id),data.d3object.attr("id",this.id),this.parent=data.parent||d.parent,this.d3object=data.d3object):(this.parent=data.parent,this.model=data.model,this.id=ormjs.View.generateID(this.model),this.create_d3object(data)),this.d3object.datum().id=this.id,this.d3object.datum().model=this.model,this.d3object.datum().parent=this.parent,this.actions(),this.record(),null==ormjs.models[this.model].currentview&&this.set_current()}static generateID(model){return ormjs.Model.generateID(model,"view")}static default_scaling(){var param={scale:ormjs.size.view.scale,scale_min:ormjs.size.view.scale_min,scale_max:ormjs.size.view.scale_max};return param.inv_scale=param.scale_max+param.scale_min-param.scale,param}static default_datum(){var d=ormjs.View.default_scaling();return d.kind="view",d}create_d3object(data){var def_d=ormjs.View.default_datum(),d=ormjs.Graph.fill_datum(data,def_d),data=(d.id=this.id,d3.select("#"+this.parent).html(""),d3.select("#"+this.parent).append("svg").datum(d).attr("id",this.id).attr("class","ormjs-svg_prototype").attr("width","100%").attr("height","100%").attr("viewBox",()=>ormjs.View.set_viewbox(d.scale)).attr("scaleValue",d.inv_scale).attr("shape-rendering","geometricPrecision"));this.d3object=data}record(){ormjs.models[this.model].objects[this.kind][this.id]=this}static set_viewbox(svgscale){return"-"+svgscale/2+", -"+svgscale/2+", "+svgscale+", "+svgscale}static from_parent(parentID){parentID=d3.select("#"+parentID).selectAll(".ormjs-svg_prototype").nodes().map(obj=>obj.id)[0];return ormjs.Graph.any_object(parentID)}svgscale_from_element(id){var d=this.d3object.datum();d.scale=ormjs.GraphUtils.parse_number(d3.select("#"+id).property("value")),d.scale_min=ormjs.GraphUtils.parse_number(d3.select("#"+id).property("min")),d.scale_max=ormjs.GraphUtils.parse_number(d3.select("#"+id).property("max")),this.update_svgscale()}update_svgscale(scaleval){var d=this.d3object.datum();1==arguments.length&&(d.scale=scaleval),d.inv_scale=d.scale_max+d.scale_min-d.scale,this.d3object.attr("viewBox",()=>ormjs.View.set_viewbox(d.inv_scale)).attr("scaleValue",d.inv_scale)}set_current(){ormjs.models[this.model].set_current_view(this.id),this.update_svgscale()}actions(){var svgMenu=ormjs.OptionMenu.svg_menu(this);this.d3object.on("contextmenu",d3.contextMenu(svgMenu)).on("mousedown",ormjs.HighlightRegion.svg_mousedown).on("click",event=>{d3.select("#ormjs-hrect").remove()}).on("dblclick",event=>{event.stopPropagation(),d3.select("#ormjs-hrect").remove(),ormjs.HighlightRegion.unselect_all(this.id);var mouse=d3.pointer(event);new(event.shiftKey&&event.ctrlKey?ormjs.Value:event.shiftKey?ormjs.Predicate:ormjs.Entity)({x:mouse[0],y:mouse[1],model:this.model})}),d3.select("body").on("keypress",event=>{13===event.keyCode&&0<ormjs.propmenu.open_popups.length&&ormjs.PropertyMenu.enter_last_popup()})}objects_in_view(){return["ormjs-entity_prototype","ormjs-value_prototype","ormjs-predicate_prototype","ormjs-constraint_prototype"].map(cls=>{return d3.select("#"+this.id).selectAll("."+cls).nodes().map(obj=>obj.id)}).flat().filter(v=>v)}everything_in_view(){return["ormjs-entity_prototype","ormjs-value_prototype","ormjs-predicate_prototype","ormjs-rolebox_prototype","ormjs-constraint_prototype","ormjs-connector_prototype"].map(cls=>{return d3.select("#"+this.id).selectAll("."+cls).nodes().map(obj=>obj.id)}).flat().filter(v=>v)}delete(){this.clear(),this.d3object.remove();var model=ormjs.models[this.model];delete model.objects[this.kind][this.id],model.update()}clear(){this.objects_in_view().map(objID=>{ormjs.Graph.any_object(objID).delete()})}},Entity:class{d3object;id;model;view;kind="entity";constructor(data){var d;data.d3object?(d=data.d3object.datum(),this.id=data.d3object.attr("id"),this.model=data.model||d.model,d.id=this.id,this.d3object=data.d3object):(this.view=data.view,this.model=data.model||ormjs.Graph.any_object(this.view).model,this.id=ormjs.Entity.generateID(this.model),this.create_d3object(data)),this.d3object.datum().model=this.model,this.view=d3.select(d3.select("#"+this.id).node().parentNode).node().id,this.d3object.datum().view=this.view,this.actions(),this.record(),data.d3object||ormjs.models[this.model].update()}static generateID(modelID){return ormjs.Model.generateID(modelID,"entity")}static is_entityID(anyID){return!!anyID.includes("entity")}create_d3object(data){var ename="Entity "+ormjs.Graph.object_number(this.id),width=ormjs.Entity.name_width(ename),height=ormjs.size.entity.height,def_d=ormjs.Entity.default_datum(),d=(def_d.name=ename,ormjs.Graph.fill_datum(data,def_d));d.x0=d.x,d.y0=d.y,d.id=this.id;ename=(data.view?d3.select("#"+data.view):ormjs.models[this.model].currentview.d3object).append("g").datum(d).attr("class","ormjs-entity_prototype").attr("id",this.id).attr("parent",this.id).attr("x",d.x).attr("y",d.y).attr("width",width).attr("height",height);ename.append("rect").attr("class","ormjs-entity").attr("id","r-"+this.id).attr("x",d.x).attr("y",d.y).attr("width",width).attr("transform",()=>ormjs.Graph.translate(-width/2,-height/2));return ename.append("text").attr("class","ormjs-ename").attr("id","t-"+this.id).attr("x",d.x0).attr("y",function(){return d.y0}).attr("text-anchor","middle").attr("dominant-baseline","central").text(function(d){return d.name}),ename.append("text").attr("class","ormjs-refmode").attr("id","tr-"+this.id).attr("x",d.x0).attr("y",function(){return d.y0+9}).attr("text-anchor","middle").attr("dominant-baseline","central").text(""),ormjs.Graph.draw_overlay(ename,"eoverlay"),this.d3object=ename,this.update_display_name(),ename}static name_width(ename){return 10*ename.length+21}update_width(){ormjs.Graph.object_width(this)}update_overlay(){ormjs.Graph.overlay_width(this)}update_display_name(){var d=this.d3object.datum(),disp_name=ormjs.Entity.format_name(d.name),ref_name="";""!=d.refmode&&(ref_name=ormjs.Entity.format_refmode(d.refmode,d.reftype)),d.independent&&(disp_name+=" !"),d3.select("#t-"+this.id).text(disp_name),d3.select("#tr-"+this.id).text(ref_name);""!=d.refmode?d3.select("#t-"+this.id).attr("y",function(){return d.y0-9}):d3.select("#t-"+this.id).attr("y",function(){return d.y0}),this.update_width()}static format_name(ename){return ename.replace(/(^\w{1})|(\s+\w{1})/g,letter=>letter.toUpperCase())}static format_refmode(initname,type="popular"){return"popular"==type&&(initname=initname.split(" ").join("_")),"popular"==type?initname=`(.${initname})`:"unit"==type?initname+=":":"general"==type&&(initname=""+initname.toUpperCase()),initname}static default_datum(){return{x:0,y:0,dx:0,dy:0,x0:0,y0:0,selected:!1,kind:"entity",connectors:[],independent:!1,refmode:"",reftype:"popular",unittype:""}}record(){ormjs.models[this.model].objects[this.kind][this.id]=this}duplicate(){var d=this.d3object.datum(),offset=.75*ormjs.size.entity.height,dc={x:d.x+offset,y:d.y+offset,model:this.model,view:this.view};["name","independent","refmode","reftype","unittype"].map(n=>{dc[n]=d[n]}),new ormjs.Entity(dc),ormjs.models[this.model].update()}actions(){var drag_entity=d3.drag().on("start",this.dragstarted).on("drag",this.dragged).on("end",this.dragended),entityMenu=ormjs.OptionMenu.entity_menu(this.model);this.d3object.on("dblclick",ormjs.PropertyMenu.popup_event).on("contextmenu",d3.contextMenu(entityMenu)).on("click",ormjs.Graph.remove).call(drag_entity),this.overlay_actions()}overlay_actions(){d3.select("#o-"+this.id).on("mousedown",event=>{this.mousedown(event,this)})}dragstarted(event,d){ormjs.Graph.dragstarted(event,d)}dragged(event,d){ormjs.Graph.dragged(event,d)}dragended(event,d){var event=ormjs.Graph.dragended(event,d),d=event.plays_lead_roles(),objects=ormjs.models[event.model].objects;d.map(rbgroupID=>{objects.predicate[rbgroupID].update_flip()})}move(){ormjs.Graph.object_move(this)}mousedown(event,entity){var d=entity.d3object.datum(),m=d3.pointer(event),width=entity.d3object.attr("width"),width={x:m[0]+d.x-width/2,y:m[1]+d.y-ormjs.size.entity.height/2};ormjs.Graph.mousedown(event,entity,width)}delete(){ormjs.Graph.delete_object(this)}closest_overlay(pos){var xyo=this.overlay_positions();return ormjs.Graph.closest_location(pos,xyo)}overlay_positions(){return ormjs.Graph.overlay_positions(this)}plays_lead_roles(){return ormjs.Graph.plays_lead_roles(this)}plays_roles(){return ormjs.Graph.plays_roles(this)}check_independence(){var n,roles=this.plays_roles();for(n in roles)if(d3.select("#"+roles[n]).datum().mandatory)return!1;return!0}can_connect(d3target){d3target=d3target.datum();return"entity"==d3target.kind||"rolebox"==d3target.kind&&null==d3target.entity}static nearest_neighbors(objID){for(var nnlist=ormjs.Connector.neighbors(objID),nodes={terminal:[],nonterminal:[]},rnds=0;0<nnlist.length&&rnds<10;){var next_nnlist=[];nnlist.map(nnID=>{nodes.terminal.includes(nnID)||(nnID.includes("entity")||nnID.includes("value")?nodes.terminal.push(nnID):(nodes.nonterminal.push(nnID),next_nnlist.push.apply(next_nnlist,ormjs.Connector.neighbors(nnID))))}),nnlist=[...next_nnlist=next_nnlist.filter(function(item,index,inputArray){return inputArray.indexOf(item)==index})],rnds+=1}return nodes.nonterminal=nodes.nonterminal.filter(value=>!("rolebox"==ormjs.Graph.object_kind(value))),nodes}},Value:class{d3object;id;model;view;kind="value";constructor(data){var d;data.d3object?(d=data.d3object.datum(),this.id=data.d3object.attr("id"),this.model=data.model||d.model,d.id=this.id,this.d3object=data.d3object):(this.view=data.view,this.model=data.model||ormjs.Graph.any_object(this.view).model,this.id=ormjs.Value.generateID(this.model),this.create_d3object(data)),this.d3object.datum().model=this.model,this.view=d3.select(d3.select("#"+this.id).node().parentNode).node().id,this.d3object.datum().view=this.view,this.actions(),this.record(),data.d3object||ormjs.models[this.model].update()}static generateID(modelID){return ormjs.Model.generateID(modelID,"value")}static is_valueID(anyID){return!!anyID.includes("value")}create_d3object(data){var vname="Value "+ormjs.Graph.object_number(this.id),width=ormjs.Value.name_width(vname),height=ormjs.size.value.height,def_d=ormjs.Value.default_datum(),vname=(def_d.name=vname,ormjs.Graph.fill_datum(data,def_d));vname.x0=vname.x,vname.y0=vname.y,vname.id=this.id;def_d=(data.view?d3.select("#"+data.view):ormjs.models[this.model].currentview.d3object).append("g").datum(vname).attr("class","ormjs-value_prototype").attr("id",this.id).attr("parent",this.id).attr("x",vname.x).attr("y",vname.y).attr("width",width).attr("height",height);return def_d.append("rect").attr("class","ormjs-value").attr("id","r-"+this.id).attr("x",vname.x).attr("y",vname.y).attr("width",width).attr("transform",()=>ormjs.Graph.translate(-width/2,-height/2)),def_d.append("text").attr("class","ormjs-vname").attr("id","t-"+this.id).attr("x",vname.x).attr("y",vname.y).attr("text-anchor","middle").attr("dominant-baseline","central").text(function(d){return d.name}),ormjs.Graph.draw_overlay(def_d,"voverlay"),this.d3object=def_d,this.update_display_name(),def_d}static name_width(vname){return 10*vname.length+21}update_width(){ormjs.Graph.object_width(this)}update_overlay(){ormjs.Graph.overlay_width(this)}update_display_name(){var d=this.d3object.datum(),d=ormjs.Value.format_name(d.name);d3.select("#t-"+this.id).text(d),this.update_width()}static format_name(vname){return vname.replace(/(^\w{1})|(\s+\w{1})/g,letter=>letter.toUpperCase())}static default_datum(){return{x:0,y:0,dx:0,dy:0,x0:0,y0:0,selected:!1,kind:"value",connectors:[],independent:!1,type:"popular"}}record(){ormjs.models[this.model].objects[this.kind][this.id]=this}duplicate(){var d=this.d3object.datum(),offset=.75*ormjs.size.value.height,dc={x:d.x+offset,y:d.y+offset,model:this.model};["name","independent","type"].map(n=>{dc[n]=d[n]}),new ormjs.Value(dc),ormjs.models[this.model].update()}actions(){var drag_value=d3.drag().on("start",this.dragstarted).on("drag",this.dragged).on("end",this.dragended),valueMenu=ormjs.OptionMenu.value_menu(this.model);this.d3object.on("dblclick",ormjs.PropertyMenu.popup_event).on("contextmenu",d3.contextMenu(valueMenu)).on("click",ormjs.Graph.remove).call(drag_value),this.overlay_actions()}overlay_actions(){d3.select("#o-"+this.id).on("mousedown",event=>{this.mousedown(event,this)})}dragstarted(event,d){ormjs.Graph.dragstarted(event,d)}dragged(event,d){ormjs.Graph.dragged(event,d)}dragended(event,d){var event=ormjs.Graph.dragended(event,d),d=event.plays_lead_roles(),objects=ormjs.models[event.model].objects;d.map(rbgroupID=>{objects.predicate[rbgroupID].update_flip()})}move(){ormjs.Graph.object_move(this)}mousedown(event,value){var d=value.d3object.datum(),m=d3.pointer(event),width=value.d3object.attr("width"),width={x:m[0]+d.x-width/2,y:m[1]+d.y-ormjs.size.value.height/2};ormjs.Graph.mousedown(event,value,width)}delete(){ormjs.Graph.delete_object(this)}closest_overlay(pos){var xyo=this.overlay_positions();return ormjs.Graph.closest_location(pos,xyo)}overlay_positions(){return ormjs.Graph.overlay_positions(this)}plays_lead_roles(){return ormjs.Graph.plays_lead_roles(this)}plays_roles(){return ormjs.Graph.plays_roles(this)}check_independence(){var n,roles=this.plays_roles();for(n in roles)if(d3.select("#"+roles[n]).datum().mandatory)return!1;return!0}can_connect(d3target){d3target=d3target.datum();return"rolebox"==d3target.kind&&null==d3target.entity}},Predicate:class{d3object;id;model;view;kind="predicate";constructor(data){var d;data&&(data.d3object?(d=data.d3object.datum(),this.id=data.d3object.attr("id"),this.model=data.model||d.model,d.id=this.id,this.d3object=data.d3object):(this.view=data.view,this.model=data.model||ormjs.Graph.any_object(this.view).model,this.id=ormjs.Predicate.generateID(this.model),this.create_d3object(data)),this.d3object.datum().model=this.model,this.view=d3.select(d3.select("#"+this.id).node().parentNode).node().id,this.d3object.datum().view=this.view,this.actions(),this.record(),data.d3object||ormjs.models[this.model].update())}static generateID(modelID){return ormjs.Model.generateID(modelID,"predicate")}static is_roleboxID(anyID){return!!anyID.includes("rolebox")}create_d3object(data){var def_d=ormjs.Predicate.default_datum(),def_d=ormjs.Graph.fill_datum(data,def_d);def_d.x0=def_d.x,def_d.xc=def_d.x,def_d.y0=def_d.y,def_d.yc=def_d.y,def_d.id=this.id;var data=(data.view?d3.select("#"+data.view):ormjs.models[this.model].currentview.d3object).append("g").datum(def_d).attr("id",this.id).attr("class","ormjs-predicate_prototype").attr("x",-ormjs.size.rolebox.width/2).attr("y",-ormjs.size.rolebox.height/2),osize=(data.append("text").attr("class","ormjs-rbname").attr("id","t-"+this.id).attr("x",function(d){return d.x0}).attr("y",function(d){return d.y0-1.5*ormjs.size.rolebox.height}).attr("text-anchor","middle").attr("dominant-baseline","center").text(function(d){return d.name}),ormjs.size.rolebox.height);data.append("path").attr("d",function(d){return ormjs.Predicate.plusPath(d,osize)}).attr("class","ormjs-rbadd").attr("id","add-"+this.id).attr("transform",()=>ormjs.Graph.translate(-ormjs.size.rolebox.width,0)),this.d3object=data,this.add_rolebox()}static plusPath(position,size){size/=2;return["M",position.x,",",position.y-size,"L",position.x,",",position.y+size,"M",position.x-size,",",position.y,"L",position.x+size,",",position.y,"Z"].join("")}add_rolebox(){var ind,d=this.d3object.datum(),rbox=new ormjs.Rolebox({predicate:this});return this.set_fact_center(),this.update_display_name(),1<d.boxes.length&&(ind=0,ind=d.flipped?1:d.boxes.length-2,ormjs.models[this.model].objects.rolebox[d.boxes[ind]].set_eligible_overlays(),ormjs.models[this.model].update()),ormjs.Connector.redraw(d.connectors),rbox}duplicate(){var n,gd=this.d3object.datum(),offset=.75*ormjs.size.rolebox.height,x=gd.x+offset,offset=gd.y+offset,predcopy=new ormjs.Predicate({x:x,y:offset,view:this.view,model:this.model}),x=predcopy.d3object.datum(),boxes=[...gd.boxes],roleboxes=(gd.flipped&&boxes.reverse(),ormjs.models[this.model].objects.rolebox),rng=(roleboxes[boxes[0]].duplicate(roleboxes[x.boxes[0]]),ormjs.GraphUtils.range(boxes.length-1,1));for(n in rng){var rbox=predcopy.add_rolebox();roleboxes[boxes[rng[n]]].duplicate(rbox)}x.name=gd.name,x.rname=gd.rname,predcopy.update_display_name(),ormjs.models[this.model].update()}static default_datum(){return{x:0,y:0,dx:0,dy:0,x0:0,y0:0,xc:0,yc:0,selected:!1,kind:"predicate",name:"",rname:"",entity_in:null,mandatory:!1,boxes:[],connectors:[],flipped:!1,rotated:!1,arrow:!1}}record(){ormjs.models[this.model].objects[this.kind][this.id]=this}update_display_name(){var gd=this.d3object.datum(),boxcount=gd.boxes.length,boxnames=this.namelist(),boxnames=(gd.name=boxnames.reduced.join(" ... "),gd.name=gd.name.trim(),gd.name),boxnames=gd.arrow?"🞀 "+gd.name:gd.name;gd.rname=ormjs.Rolebox.format_name(gd.rname),0<gd.rname.length&&(boxnames+=" / "+gd.rname),d3.select("#t-"+this.id).text(boxnames).attr("x",function(){return gd.x0+(boxcount-1)*ormjs.size.rolebox.width/2})}namelist(){var gd=this.d3object.datum(),boxes=[...gd.boxes],gd=(boxes=1==gd.flipped?boxes.reverse():boxes).map(boxID=>{boxID=d3.select("#"+boxID).datum();return boxID.name=ormjs.Rolebox.format_name(boxID.name),boxID.name}),boxes=[gd.slice(0,2).join(" ")];return boxes.push.apply(boxes,gd.slice(2,gd.length)),{all:gd,reduced:boxes}}move(){var d=this.d3object.datum();d.rotated?this.d3object.attr("transform",()=>ormjs.Graph.translate_rotate(d.x,d.y,d.dx,d.dy)):this.d3object.attr("transform",()=>ormjs.Graph.translate(d.dx,d.dy)),this.position_boxes(),this.update_flip()}actions(){var drag_predicate=d3.drag().on("start",this.dragstarted).on("drag",this.dragged).on("end",this.dragended);this.d3object.on("dblclick",ormjs.PropertyMenu.popup_event).call(drag_predicate),d3.select("#add-"+this.id).on("dblclick",event=>{event.stopPropagation()}).on("click",function(event){event=ormjs.Graph.get_parentID(event.target.id.toString());ormjs.Graph.any_object(event).add_rolebox()})}dragstarted(event,d){ormjs.Graph.dragstarted(event,d).bubble_connectors()}dragged(event,d){ormjs.Graph.dragged(event,d)}dragended(event,d){ormjs.Graph.dragended(event,d)}position_boxes(){var n,gd=this.d3object.datum();for(n in gd.boxes){var d=d3.select("#"+gd.boxes[n]).datum();gd.rotated?(d.y=gd.y+n*ormjs.size.rolebox.width,d.x=gd.x):(d.x=gd.x+n*ormjs.size.rolebox.width,d.y=gd.y)}this.set_fact_center()}set_fact_center(){var d=this.d3object.datum(),shift=-.5*ormjs.size.rolebox.width+d.boxes.length*ormjs.size.rolebox.width/2;d.rotated?(d.yc=d.y+shift,d.xc=d.x):(d.xc=d.x+shift,d.yc=d.y)}bubble_connectors(){var gd=this.d3object.datum(),connlist=gd.boxes.map(boxID=>{return[...d3.select("#"+boxID).datum().connectors]}).flat().filter(v=>v);gd.connectors=connlist}update_flip(){var d=this.d3object.datum();this.check_flip_condition().flip&&this.flip(),ormjs.Connector.redraw(d.connectors)}flip(){var gd=this.d3object.datum();gd.flipped?gd.flipped=!1:gd.flipped=!0,gd.arrow=gd.flipped,gd.boxes=gd.boxes.reverse(),this.align(),this.update_display_name(),ormjs.Connector.redraw(gd.connectors)}align(){var n,gd=this.d3object.datum(),roleboxes=ormjs.models[this.model].objects.rolebox,x=gd.x0,y=gd.y0;for(n in gd.boxes)roleboxes[gd.boxes[n]].move(x,y),roleboxes[gd.boxes[n]].set_eligible_overlays(),x+=ormjs.size.rolebox.width;this.position_boxes()}check_flip_condition(){var ed,isflipped,flipme,gd=this.d3object.datum(),flipit={flip:!1,arrow:gd.arrow};return null!=gd.entity_in&&1!=gd.boxes.length&&(ed=d3.select("#"+gd.entity_in).datum(),isflipped=flipme=0,isflipped=gd.flipped?1:0,flipme=gd.rotated?gd.yc<ed.y?1-isflipped:isflipped:gd.xc<ed.x?1-isflipped:isflipped,flipit.flip=(gd={0:!1,1:!0})[flipme],flipit.arrow=gd[Math.abs(isflipped-flipme)]),flipit}rotate(){var d=this.d3object.datum();d.rotated=!d.rotated,d.rotated?this.d3object.attr("transform",()=>ormjs.Graph.translate_rotate(d.x,d.y,d.dx,d.dy)):this.d3object.attr("transform",()=>ormjs.Graph.translate(d.dx,d.dy)),this.position_boxes(),this.update_flip()}delete(){var n,boxes=[...this.d3object.datum().boxes],roleboxes=ormjs.models[this.model].objects.rolebox;for(n in ormjs.Graph.delete_object(this),boxes)delete roleboxes[boxes[n]]}set_subject(){var gd=this.d3object.datum(),ind=0,boxes=gd.boxes,ind=gd.flipped?boxes.length-1:0;gd.entity_in=d3.select("#"+boxes[ind]).datum().entity}role_players(){return this.d3object.datum().boxes.map(boxID=>d3.select("#"+boxID).datum().entity).filter(v=>v)}},Rolebox:class{d3object;id;parent;model;view;kind="rolebox";constructor(data){var d;data.d3object?(d=data.d3object.datum(),this.id=data.d3object.attr("id"),this.parent=d.parent,this.view=d.view,this.model=data.model||d.model,d.id=this.id,this.d3object=data.d3object):(this.model=data.predicate.model,this.view=data.predicate.view,this.parent=data.predicate.id,this.create_d3object(data)),this.d3object.datum().model=this.model,this.d3object.datum().view=this.view,this.actions(),this.record(),data.d3object||ormjs.models[this.model].update()}create_d3object(data){data=ormjs.Rolebox.draw_box(data);return this.id=data.attr("id"),this.d3object=data,this.add_overlay(),data}static draw_box(data){var rbgroup=data.predicate.d3object,d=rbgroup.datum(),boxcount=d.boxes.length,rbID=rbgroup.attr("id"),boxID="r-"+boxcount.toString()+"-"+rbID,rbname="rolebox "+boxcount.toString(),def_d=ormjs.Rolebox.default_datum(),def_d={...{x:d.x+boxcount*ormjs.size.rolebox.width,y:d.y,dx:boxcount*ormjs.size.rolebox.width,name:rbname,parent:rbID},...def_d},rbname=ormjs.Graph.fill_datum(data,def_d),rbgroup=(rbgroup.append("g").datum(rbname).attr("class","ormjs-rolebox_prototype").attr("id",boxID).attr("parent",rbID).attr("x",function(){return d.x0+boxcount*ormjs.size.rolebox.width}).attr("y",function(){return d.y0}).attr("width",ormjs.size.rolebox.width).attr("height",ormjs.size.rolebox.height).append("rect").attr("class","ormjs-rolebox").attr("id","r-"+boxID).attr("width",ormjs.size.rolebox.width).attr("height",ormjs.size.rolebox.height).attr("x",function(){return d.x0+boxcount*ormjs.size.rolebox.width}).attr("y",function(){return d.y0}).attr("transform",()=>ormjs.Graph.translate(-ormjs.size.rolebox.width/2,-ormjs.size.rolebox.height/2)),d.flipped?((def_d=[...d.boxes]).reverse(),def_d.push(boxID),def_d.reverse(),d.boxes=[...def_d],d.dx-=ormjs.size.rolebox.width,d.x=d.x0+d.dx,data.predicate.move(),data.predicate.align()):d.boxes.push(boxID),d3.select("#"+boxID));return rbgroup.append("path").attr("d","").attr("class","ormjs-rb_constraint").attr("id","c-"+boxID),rbgroup}add_overlay(){ormjs.Graph.draw_overlay(this.d3object,"rboverlay").attr("rbox",this.id)}duplicate(targetbox){targetbox.d3object.datum().name=this.d3object.datum().name,targetbox.d3object.datum().multiplicity=this.d3object.datum().multiplicity,targetbox.set_internal_uc()}set_internal_uc(){ormjs.Rolebox.set_rolebox_iuc(this.d3object)}static set_rolebox_iuc(d3object){var gd=d3.select("#"+d3object.datum().parent).datum(),d=d3object.datum(),pos={x:gd.x0+d.x-gd.x,y:gd.y0},uconstraints={},gd=ormjs.Rolebox.multiplicity();uconstraints[gd.none]=function(){return""},uconstraints[gd.many]=ormjs.IUC.many,uconstraints[gd.one]=ormjs.IUC.unique,uconstraints[gd.skip]=ormjs.IUC.skip,d3.select("#c-"+d3object.attr("id")).attr("d",()=>uconstraints[d.multiplicity]({x:0,y:0})).attr("transform",()=>ormjs.Graph.translate(pos.x,pos.y))}static multiplicity(){return{none:"none",one:"one",many:"many",skip:"skip"}}static default_datum(){return{kind:"rolebox",multiplicity:ormjs.Rolebox.multiplicity().none,entity:null,mandatory:!1,connectors:[],selected:!1}}record(){ormjs.models[this.model].objects[this.kind][this.id]=this}static format_name(rbname){return rbname.replace(/(^\w{1})|(\s+\w{1})/g,letter=>letter.toLowerCase()).trim()}actions(){var rboxMenu=ormjs.OptionMenu.rolebox_menu(this.model);this.d3object.on("contextmenu",d3.contextMenu(rboxMenu)).on("click",this.remove),d3.select("#o-"+this.id).on("contextmenu",event=>{event.stopPropagation()}).on("mousedown",event=>{this.mousedown(event,this)})}move(x,y){this.d3object.attr("x",x).attr("y",y),d3.select("#r-"+this.id).attr("x",x).attr("y",y),d3.select("#c-"+this.id).attr("transform",()=>ormjs.Graph.translate(x,y));var width=parseInt(this.d3object.attr("width")),height=parseInt(1.5*this.d3object.attr("height"));d3.select("#o-"+this.id).attr("transform",()=>ormjs.Graph.overlay_translate(x,y,width,height))}mousedown(event,rbox){var gd=d3.select("#"+rbox.d3object.datum().parent).datum(),d=rbox.d3object.datum(),m=d3.pointer(event),mousepos={x:m[0]+d.x-ormjs.size.rolebox.width/2,y:m[1]+d.y-ormjs.size.rolebox.height/2};gd.rotated&&(mousepos={y:m[0]-ormjs.size.rolebox.width/2+d.y,x:-m[1]+ormjs.size.rolebox.height/2+d.x}),ormjs.Graph.mousedown(event,rbox,mousepos)}flip_mandatory(){var d=this.d3object.datum();if(null!=d.entity){var n,conn,objects=ormjs.models[this.model].objects,conntypes=ormjs.Connector.supported_types().names;for(n in d.mandatory?d.mandatory=!1:d.mandatory=!0,d.connectors)d3.select("#"+d.connectors[n]).datum().conntype!=conntypes.EtoRB&&d3.select("#"+d.connectors[n]).datum().conntype!=conntypes.VtoRB||(d3.select("#"+d.connectors[n]).datum().mandatory=d.mandatory,conn=objects.connector[d.connectors[n]]);conn.update_location(),d.mandatory&&(d3.select("#"+d.entity).datum().independent=!1,ormjs.Graph.any_object(d.entity).update_display_name()),ormjs.models[this.model].update()}}remove(event,d){var rboxID=ormjs.Graph.levelupID(event.target.id.toString()),rboxID=ormjs.Graph.any_object(rboxID);null==rboxID||!event.ctrlKey&&2!=event.buttons||rboxID.delete()}delete(){var objects=ormjs.models[this.model].objects,rbgroup=objects.predicate[this.parent],gd=rbgroup.d3object.datum();this.id!=gd.boxes[gd.boxes.length-1]&&!gd.flipped||this.id!=gd.boxes[0]&&gd.flipped||(1==gd.boxes.length?rbgroup.delete():([...this.d3object.datum().connectors].map(connID=>{gd.connectors=ormjs.GraphUtils.remove_from_array(gd.connectors,connID),objects.connector[connID].delete()}),gd.boxes=ormjs.GraphUtils.remove_from_array(gd.boxes,this.id),delete objects.rolebox[this.id],this.d3object.remove(),gd.flipped&&(gd.dx+=ormjs.size.rolebox.width,gd.x=gd.x0+gd.dx,rbgroup.move(),rbgroup.align(),1==gd.boxes.length&&rbgroup.flip()),rbgroup.update_display_name(),objects.rolebox[gd.boxes[gd.boxes.length-1]].set_eligible_overlays(),rbgroup.set_fact_center(),d3.select("#pop-"+rbgroup.id).empty()||remove_popup(d3.select("#pop-"+rbgroup.id)),ormjs.models[this.model].update()))}closest_overlay(pos,locations=ormjs.default_dragevent){var xyo=this.overlay_positions();return ormjs.Graph.closest_location(pos,xyo,locations)}overlay_positions(){var parentID=this.d3object.datum().parent;return d3.select("#"+parentID).datum().rotated?ormjs.Graph.rotated_overlay_positions(this):ormjs.Graph.overlay_positions(this)}set_eligible_overlays(){var conns=d3.select("#"+this.id).datum().connectors,connectors=ormjs.models[this.model].objects.connector;conns.map(connID=>{connectors[connID].set_eligible_overlays()})}bubble_connectors(){this.set_role_player();var predicates=ormjs.models[this.model].objects.predicate;predicates[this.parent].bubble_connectors(),predicates[this.parent].set_subject()}set_role_player(){var connectors=this.d3object.datum().connectors;this.d3object.datum().entity=null,connectors.map(connID=>{connID=d3.select("#"+d3.select("#"+connID).datum().from);"entity"!=connID.datum().kind&&"value"!=connID.datum().kind||(this.d3object.datum().entity=connID.attr("id"))})}eligible_locations(linkto="entity",loc=ormjs.default_dragevent){var rblocations={left:["bottom","top","left"],right:["bottom","right","top"],middle:["bottom","top"],only:ormjs.default_dragevent},rbposition=this.position();return"entity"==linkto||"value"==linkto?null!=rbposition.relative?rblocations[rbposition.relative]:loc:"constraint"==linkto?(2<(rblocations=loc.dragevent).length&&(rblocations={left:["left"],right:["right"],top:["top","bottom"],bottom:["top","bottom"]}[loc.closest]),"left"==rbposition.relative&&rblocations.includes("left")||"right"==rbposition.relative&&rblocations.includes("right")||"only"==rbposition.relative?["top","bottom"]:rblocations):loc}position(){var boxes=d3.select("#"+this.parent).datum().boxes,index=boxes.indexOf(this.id),position={relative:null,absolute:index,number:boxes.length};return 0==index&&index==boxes.length-1?position.relative="only":0==index?position.relative="left":index==boxes.length-1?position.relative="right":0<index&&index<boxes.length-1&&(position.relative="middle"),position}entity_connector(){var n,connlist=this.d3object.datum().connectors,conntypes=ormjs.Connector.supported_types().names,connectors=ormjs.models[this.model].objects.connector;for(n in connlist){var cd=connectors[connlist[n]].d3object.datum();if(cd.conntype==conntypes.EtoRB||cd.conntype==conntypes.VtoRB)return connlist[n]}return null}},IUC:class{static unique(pos){var margin=ormjs.size.rolebox.width/8,start=pos.x-ormjs.size.rolebox.width/2+margin,end=start+(ormjs.size.rolebox.width-2*margin),pos=pos.y-ormjs.size.rolebox.height/2-margin;return["M",start,",",pos,"L",end,",",pos,"Z"].join("")}static many(pos){var margin=ormjs.size.rolebox.width/8,start=pos.x-ormjs.size.rolebox.width/2,end=start+ormjs.size.rolebox.width,pos=pos.y-ormjs.size.rolebox.height/2-margin;return["M",start,",",pos,"L",end,",",pos,"Z"].join("")}static skip(pos){var margin=ormjs.size.rolebox.width/8,w=ormjs.size.connector.stroke,start=pos.x-ormjs.size.rolebox.width/2+margin/2,end=start+ormjs.size.rolebox.width,y=pos.y-ormjs.size.rolebox.height/2-margin,mypath=["M",start,",",y,"L",start+w,",",y];for(start+=margin;start<end;)mypath.push.apply(mypath,["M",start,",",y,"L",start+w,",",y]),start+=margin;return mypath.push("Z"),mypath.join("")}}};ormjs.Constraint=class{d3object;id;kind="constraint";model;view;param={oradius:ormjs.size.constraint.oradius,radius:ormjs.size.constraint.radius,stroke:ormjs.size.constraint.stroke};constructor(data){var d;data.d3object?(d=data.d3object.datum(),this.id=data.d3object.attr("id"),this.model=data.model||d.model,d.id=this.id,this.d3object=data.d3object):(this.view=data.view,this.model=data.model||ormjs.Graph.any_object(this.view).model,this.id=ormjs.Constraint.generateID(this.model),this.create_d3object(data)),this.d3object.datum().model=this.model,this.view=d3.select(d3.select("#"+this.id).node().parentNode).node().id,this.d3object.datum().view=this.view,this.actions(),this.record(),data.d3object||ormjs.models[this.model].update()}static generateID(modelID){return ormjs.Model.generateID(modelID,"constraint")}create_d3object(data){var default_type=ormjs.Constraint.supported_types().names.inclusive_or,svg=data.view?d3.select("#"+data.view):ormjs.models[this.model].currentview.d3object,x=data.x,y=data.y,data=svg.append("g").datum({x:x,y:y,dx:x,dy:y,x0:0,y0:0,selected:!1,connectors:[],id:this.id,kind:"constraint",type:default_type,content:"",deontic:!1,ring:!1,obligatory:!1}).attr("class","ormjs-constraint_prototype").attr("id",this.id).attr("parent",this.id).attr("width",2*this.param.radius).attr("height",2*this.param.radius);data.append("circle").attr("class","ormjs-overlay coverlay").attr("id","o-"+this.id).attr("r",this.param.oradius),ormjs.Constraint.draw_constraint(data),data.attr("transform",()=>ormjs.Graph.translate(x,y)),this.d3object=data}record(){ormjs.models[this.model].objects[this.kind][this.id]=this}redraw(){this.set_content(),this.set_radius(),d3.select("#"+this.id).attr("width",2*this.param.radius).attr("height",2*this.param.radius),d3.select("#o-"+this.id).attr("r",this.param.oradius),ormjs.Constraint.draw_constraint(this.d3object),ormjs.Connector.redraw(this.d3object.datum().connectors)}set_content(val){var allow_content=["internal-frequency","external-frequency","role-value"],d=this.d3object.datum();"subset"==d.type?d.content="⊆":allow_content.includes(d.type)||(d.content=""),1==arguments.length&&allow_content.includes(d.type)&&(d.content=val),d.content=d.content.replaceAll(" ",""),d.content=d.content.replace(">=","≥"),d.content=d.content.replace("<=","≤")}set_radius(){var dr,newr,r=ormjs.size.constraint.radius,or=ormjs.size.constraint.oradius;0<this.d3object.datum().content.length&&(dr=or-r,newr=(12*this.d3object.datum().content.length+4)/2,newr-=4*(this.d3object.datum().content.split(".").length-1),or=(r=Math.max(newr,r))+dr),this.param.radius=r,this.param.oradius=or}static supported_types(){return{names:{inclusive_or:"inclusive-or",exclusion:"exclusion",exclusive_or:"exclusive-or",equality:"equality",external_freq:"external-frequency",internal_freq:"internal-frequency",identifier:"identifier",preferred_id:"preferred-identifier",subset:"subset",role_value:"role-value"},list:["inclusive-or","exclusion","exclusive-or","equality","identifier","preferred-identifier","subset","external-frequency","internal-frequency"]}}static draw_constraint(d3parent){var id=d3parent.attr("id"),radius=(d3.select("#c-"+id).remove(),d3parent.attr("width")/2);d3parent.append("circle").attr("class","ormjs-constraint").attr("id","c-"+id).attr("shape-rendering","geometricPrecision").attr("r",radius),"internal-frequency"==d3parent.datum().type&&ormjs.Graph.class_as("c-"+id,"clear"),ormjs.Constraint.draw_constraint_path(d3parent)}static draw_constraint_path(d3parent){var id=d3parent.attr("id"),constrainttype=(d3.select("#val-"+id).remove(),d3parent.datum().type),path=ormjs.Constraint.constraint_path(d3parent);null!=path?(d3parent.datum().content="",d3parent.append("path").attr("d",path).attr("class","ormjs-constraint_val "+constrainttype).attr("id","val-"+id)):d3parent.append("text").attr("text-anchor","middle").attr("dominant-baseline","central").attr("class","ormjs-constraint_text "+constrainttype).attr("id","val-"+id).text(d3parent.datum().content)}static constraint_path(d3object,r=-1){return r<0&&(r=d3object.attr("width")/2),{"inclusive-or":()=>ormjs.ConstraintPath.inclusive_or(r),exclusion:()=>ormjs.ConstraintPath.exclusion(r),"exclusive-or":()=>ormjs.ConstraintPath.exclusive_or(r),equality:()=>ormjs.ConstraintPath.equality(r),identifier:()=>ormjs.ConstraintPath.identifier(r),"preferred-identifier":()=>ormjs.ConstraintPath.preferred_identifier(r)}[d3object.datum().type]}static valid_frequency_content(str){if(0==str.length)return!1;var rgnum="(-)?[0-9]+((.)?[0-9]+)?";return!!new RegExp("^([><≥≤])?(=)?( )?([([]( )?)?"+rgnum+"(( )?(..( )?)?(-)?[0-9]+((.)?[0-9]+)?)?(( )?[)]]?)?$").test(str)}duplicate(){var d=this.d3object.datum(),offset=2*this.param.radius,offset={x:d.x+offset,y:d.y+offset,view:this.view,model:this.model},offset=new ormjs.Constraint(offset),dc=offset.d3object.datum();["type","content","deontic","ring","obligatory"].map(n=>{dc[n]=d[n]}),offset.redraw(),ormjs.models[this.model].update()}actions(){var drag_constraint=d3.drag().on("start",this.dragstarted).on("drag",this.dragged).on("end",this.dragended),constraintMenu=ormjs.OptionMenu.constraint_menu(this.model);this.d3object.on("dblclick",ormjs.PropertyMenu.popup_event).on("contextmenu",d3.contextMenu(constraintMenu)).on("click",ormjs.Graph.remove).call(drag_constraint),d3.select("#o-"+this.id).on("mousedown",event=>{this.mousedown(event,this)})}dragstarted(event,d){ormjs.Graph.dragstarted(event,d)}dragged(event,d){ormjs.Graph.dragged(event,d)}dragended(event,d){ormjs.Graph.dragended(event,d)}move(){ormjs.Graph.object_move(this)}mousedown(event,constraint){var d=constraint.d3object.datum(),m=d3.pointer(event),m={x:m[0]+d.x,y:m[1]+d.y};ormjs.Graph.mousedown(event,constraint,m)}delete(){ormjs.Graph.delete_object(this)}closest_overlay(pos){var d=this.d3object.datum(),d={x1:d.x,y1:d.y,x2:pos.x,y2:pos.y,r:this.param.radius};return ormjs.Geometry.point_on_circle(d)}roles(){var conns=this.d3object.datum().connectors,conntypes=ormjs.Connector.supported_types().names,connectors=ormjs.models[this.model].objects.connector;return conns.map(connID=>{connID=connectors[connID].d3object.datum();if(connID.conntype==conntypes.CtoRB)return connID.to}).filter(v=>v)}subtype_roles(){var conns=this.d3object.datum().connectors,conntypes=ormjs.Connector.supported_types().names,connectors=ormjs.models[this.model].objects.connector;return conns.map(connID=>{connID=connectors[connID].d3object.datum();if(connID.conntype==conntypes.CtoS)return connID.to}).filter(v=>v)}entities(){var entities=this.roles().map(rboxID=>d3.select("#"+rboxID).datum().entity),subroles=this.subtype_roles();return entities.push.apply(entities,subroles.map(connID=>d3.select("#"+connID).datum().to)),entities}primary_entities(){var entities=this.roles().map(rboxID=>{return d3.select("#"+d3.select("#"+rboxID).attr("parent")).datum().entity_in}),subroles=this.subtype_roles();return entities.push.apply(entities,subroles.map(connID=>d3.select("#"+connID).datum().from)),entities}neighbor_roles(){var conns=this.d3object.datum().connectors,conntypes=ormjs.Connector.supported_types().names,connectors=ormjs.models[this.model].objects.connector,lr=["left","right"];return conns.map(connID=>{connID=connectors[connID].d3object.datum();if(connID.conntype==conntypes.CtoRB)return lr.includes(connID.to_loc[0])?{rboxID:connID.to,location:connID.to_loc[0],directed:connID.directed,auto:!0}:{rboxID:connID.to,location:connID.to_loc[0],directed:connID.directed,auto:!1}}).filter(v=>v).map(r=>{var auto,boxes=[...d3.select("#"+d3.select("#"+r.rboxID).attr("parent")).datum().boxes],ind=boxes.indexOf(r.rboxID),neighborlist=[];return 0<ind&&(auto=r.auto,"right"==r.location&&(auto=!1),neighborlist.push({rboxID:boxes[ind-1],location:"right",directed:r.directed,auto:auto})),ind<boxes.length-1&&(auto=r.auto,"left"==r.location&&(auto=!1),neighborlist.push({rboxID:boxes[ind+1],location:"left",directed:r.directed,auto:auto})),neighborlist}).flat().filter(v=>v)}propagate_roles(){var roles=this.roles(),neighbors=this.neighbor_roles(),dragevent=ormjs.models[this.model].dragevent;neighbors.map(r=>{!roles.includes(r.rboxID)&&r.auto&&(dragevent.locations=[r.location],r.directed?ormjs.Connector.connect_by_id(this.id,r.rboxID):ormjs.Connector.connect_by_id(r.rboxID,this.id))}).filter(v=>v),dragevent.locations=dragevent.all_locations}can_connect(d3target){var d=d3target.datum();if("rolebox"==d.kind)return this._can_connect_rolebox(d3target);var conntypes=ormjs.Connector.supported_types().names;return"connector"==d.kind&&d.conntype==conntypes.subtype&&this._can_connect_subtype(d3target)}_can_connect_rolebox(d3target){var d=d3target.datum(),ctd=this.d3object.datum(),constrainttypes=ormjs.Constraint.supported_types().names;if(null==d.entity)return!1;if(0==ctd.connectors.length)return!0;var roles=this.subtype_roles();return!(0<roles.length)&&(!(roles=this.roles()).includes(d3target.attr("id"))&&([constrainttypes.role_value].includes(ctd.type)?!(0<ctd.connectors.length):[constrainttypes.internal_freq].includes(ctd.type)?!!this.neighbor_roles().map(r=>r.rboxID).includes(d3target.attr("id")):[constrainttypes.identifier,constrainttypes.preferred_id,constrainttypes.external_freq].includes(ctd.type)?(roles=d3.select("#"+d.parent).datum().entity_in)!=d.entity&&!!this.primary_entities().includes(roles):!!this.entities().includes(d.entity)||!!this.neighbor_roles().map(r=>r.rboxID).includes(d3target.attr("id"))))}_can_connect_subtype(d3target){var d=d3target.datum(),ctd=this.d3object.datum(),constrainttypes=ormjs.Constraint.supported_types().names;if(![constrainttypes.exclusion,constrainttypes.exclusive_or,constrainttypes.inclusive_or].includes(ctd.type))return!1;if(0==ctd.connectors.length)return!0;constrainttypes=this.roles();return!(0<constrainttypes.length)&&(!(constrainttypes=this.subtype_roles()).includes(d3target.attr("id"))&&!!this.entities().includes(d.to))}},ormjs.ConstraintPath=class{static exclusion(r){r/=Math.sqrt(2);return["M",0,",",0,"L",r,",",r,"M",0,",",0,"L",r,",",-r,"M",0,",",0,"L",-r,",",r,"M",0,",",0,"L",-r,",",-r,"Z"].join("")}static inclusive_or(r){return ormjs.ConstraintPath.dot(0,0,r/3)+"Z"}static exclusive_or(r){return ormjs.ConstraintPath.noZ(ormjs.ConstraintPath.exclusion(r))+ormjs.ConstraintPath.inclusive_or(r)}static equality(r){var str=ormjs.size.connector.stroke;return ormjs.ConstraintPath.hline(8,2+str/2,r)+ormjs.ConstraintPath.hline(8,-2,r)+"Z"}static identifier(r){return ormjs.ConstraintPath.hline(0,0,r)+"Z"}static preferred_identifier(r){return ormjs.ConstraintPath.hline(0,2,r)+ormjs.ConstraintPath.hline(0,-2,r)+"Z"}static noZ(str){return str.substring(0,str.length-2)}static dot(x,y,r){return["M",x,",",y,"m",-r,0,"a",r,",",r,"0 1, 0 ",2*r,",",0,"a",r,",",r,"0 1, 0 ",-2*r,",",0].join(" ")}static hline(dx,dy,r){return["M",-r*Math.cos(Math.abs(dy)/r)+dx,",",dy,"L",r*Math.cos(Math.abs(dy)/r)-dx,",",dy].join("")}},ormjs.Connector=class{d3object;id;model;view;kind="connector";constructor(data){var d;data.d3object?(d=data.d3object.datum(),this.id=data.d3object.attr("id"),this.model=data.model||d.model,d.id=this.id,this.d3object=data.d3object):(this.view=data.view,this.model=data.model||ormjs.Graph.any_object(this.view).model,this.id=ormjs.Connector.generateID(this.model),this.create_d3object(data)),this.d3object.datum().model=this.model,this.view=d3.select(d3.select("#"+this.id).node().parentNode).node().id,this.d3object.datum().view=this.view,this.actions()}static generateID(modelID){return ormjs.Model.generateID(modelID,"connector")}static find(from_id,to_id){var n,to_id=d3.select("#"+to_id).datum(),connlist=to_id.connectors,objects=ormjs.models[to_id.model];for(n in connlist)if(objects.connector[connlist[n]].d3object.datum().from==from_id)return connlist[n];return null}static redraw(conns){var connectors,conntypes;0!=conns.length&&(connectors=ormjs.Graph.model_from_id(conns[0]).objects.connector,conntypes=ormjs.Connector.supported_types().names,conns.map(connID=>{connectors[connID].update_location(),connectors[connID].d3object.datum().conntype==conntypes.subtype&&connectors[connID].d3object.datum().connectors.map(moreconnID=>{connectors[moreconnID].update_location()})}))}static connect_by_id(aID,bID){var obja=d3.select("#"+aID),objb=d3.select("#"+bID),objb={x1:obja.datum().x,y1:obja.datum().y,x2:objb.datum().x,y2:objb.datum().y,model:obja.datum().model,view:obja.datum().view},obja=new ormjs.Connector(objb),objb=obja.d3object.datum();return objb.from=aID,objb.to=bID,obja.connect(),obja}static supported_types(){return{names:{subtype:"subtype",default:"default",EtoRB:"EtoRB",VtoRB:"VtoRB",CtoRB:"CtoRB",CtoS:"CtoS"},classes:{subtype:"subtype",default:"line",EtoRB:"line",VtoRB:"line",mandatory:"line",CtoRB:"constraint",CtoS:"constraint"}}}create_d3object(data){var conninfo=ormjs.Connector.supported_types(),conntype=conninfo.names.default;data.conntype&&(conntype=data.conntype);var connector=(data.view?d3.select("#"+data.view):ormjs.models[this.model].currentview.d3object).append("g").datum({x1:data.x1,y1:data.y1,x2:data.x2,y2:data.y2,kind:"connector",selected:!1,conntype:conntype,preferred:!1,mandatory:!1,directed:!1,from:"",to:"",connectors:[],from_loc:ormjs.default_dragevent,to_loc:ormjs.default_dragevent}).attr("class","ormjs-connector_prototype").attr("id",this.id);connector.append("path").attr("class","ormjs-connector "+conninfo.classes[conntype]).attr("id","p-"+this.id).attr("d",d3.line()([[data.x1,data.y1],[data.x2,data.y2]])),connector.append("path").attr("class","ormjs-connector clear").attr("id","o-"+this.id).attr("d",d3.line()([[data.x1,data.y1],[data.x2,data.y2]])),this.d3object=connector}paths(){return[...this.d3object._groups[0][0].childNodes].map(n=>n.id)}draw(){var type,conn=this.d3object,connpath=d3.select("#p-"+this.id),connover=d3.select("#o-"+this.id),np=conn.attr("class").includes("ormjs-notparsed")?" ormjs-notparsed":"",cd=conn.datum(),lineparam=ormjs.Geometry.resize_and_rotate(cd),conninfo=ormjs.Connector.supported_types(),conntypes=conninfo.names,conninfo=conninfo.classes;cd.conntype==conntypes.default?(connpath.attr("d",d3.line()([[cd.x1,cd.y1],[cd.x2,cd.y2]])).attr("class","ormjs-connector "+conninfo.default+np),connover.attr("d",null)):cd.conntype==conntypes.CtoRB||cd.conntype==conntypes.CtoS?(type=d3.select("#"+cd.from).datum().type,["subset"].includes(type)&&cd.directed?(connpath.attr("d",function(){return ormjs.ConnPath.linePathArrow(lineparam.length)}).attr("class","ormjs-connector "+conninfo.CtoRB+np),connover.attr("d",function(){return ormjs.ConnPath.constraintArrowPath(lineparam.length)}).attr("class","ormjs-connector clear arrow"+np)):""==cd.to||""==cd.from?(connpath.attr("d",function(){return ormjs.ConnPath.linePath(lineparam.length)}).attr("class","ormjs-connector "+conninfo.CtoRB+np),connover.attr("d",function(){return ormjs.ConnPath.linePath(lineparam.length)}).attr("class","ormjs-connector clear"+np)):(connpath.attr("d",function(){return ormjs.ConnPath.linePath(lineparam.length)}).attr("class",`ormjs-connector ${conninfo.CtoRB} connected`+np),connover.attr("d",function(){return ormjs.ConnPath.linePath(lineparam.length)}).attr("class","ormjs-connector clear arrow"+np)),conn.attr("transform",lineparam.transform)):cd.conntype==conntypes.subtype?(cd.preferred?connpath.attr("d",function(){return ormjs.ConnPath.subtypePath(lineparam.length)}).attr("class","ormjs-connector "+conninfo.subtype+np):connpath.attr("d",function(){return ormjs.ConnPath.linePathArrow(lineparam.length)}).attr("class",`ormjs-connector ${conninfo.subtype} dashed`+np),connover.attr("d",function(){return ormjs.ConnPath.subtypePathDashed(lineparam.length)}).attr("class","ormjs-connector clear arrow"+np),conn.attr("transform",lineparam.transform)):cd.conntype!=conntypes.EtoRB&&cd.conntype!=conntypes.VtoRB||(cd.mandatory?(connpath.attr("d",function(){return ormjs.ConnPath.linePath(lineparam.length)}).attr("class","ormjs-connector "+conninfo.mandatory+np),connover.attr("d",function(){return ormjs.ConnPath.mandatoryPath(lineparam.length)}).attr("class","ormjs-connector clear"+np)):(connpath.attr("d",function(){return ormjs.ConnPath.linePath(lineparam.length)}).attr("class","ormjs-connector "+conninfo[cd.conntype]+np),connover.attr("d",function(){return ormjs.ConnPath.linePath(lineparam.length)}).attr("class","ormjs-connector clear"+np)),conn.attr("transform",lineparam.transform))}record(){ormjs.models[this.model].objects[this.kind][this.id]=this}connect(){var d;this.can_connect()?(this.attach(),this.record(),this.assign_role()?(this.update_location(),ormjs.models[this.model].update()):(console.log(`Logic Error: connection allowed between ${d.from} and ${d.to} but not assignable. This shouldn't happen.`),this.delete())):(d=this.d3object.datum(),console.log(`ORM Logic Error: connection not allowed between ${d.from} and ${d.to}.`),this.shallow_delete())}can_connect(){var cd=this.d3object.datum(),d_from=d3.select("#"+cd.from).datum(),conntypes=ormjs.Connector.supported_types().names,objects=ormjs.models[this.model].objects,d_to=("rolebox"==d_from.kind||"connector"==d_from.kind?this.flip():cd.directed=!0,d3.select("#"+cd.to).datum());return"entity"==(d_from=d3.select("#"+cd.from).datum()).kind?!!objects.entity[cd.from].can_connect(d3.select("#"+cd.to))&&("rolebox"==d_to.kind?(cd.conntype=conntypes.EtoRB,!0):"entity"==d_to.kind?(cd.conntype=conntypes.subtype,cd.preferred=!0):(console.log(`Logic Error: entity ${cd.from} can connect to object ${cd.to}, `+"but connection type undetermined. This shouldn't happen."),!1)):"value"==d_from.kind?!!objects.value[cd.from].can_connect(d3.select("#"+cd.to))&&("rolebox"==d_to.kind?(cd.conntype=conntypes.VtoRB,!0):(console.log(`Logic Error: value ${cd.from} can connect to object ${cd.to}, `+"but connection type undetermined. This shouldn't happen."),!1)):"constraint"==d_from.kind&&(!!objects.constraint[cd.from].can_connect(d3.select("#"+cd.to))&&("rolebox"==d_to.kind?cd.conntype=conntypes.CtoRB:cd.conntype=conntypes.CtoS,!0))}update_location(){var cd=this.d3object.datum(),to_pos=ormjs.Graph.closest_overlay(d3.select("#"+cd.from).datum(),cd.to,cd.to_loc),from_pos=ormjs.Graph.closest_overlay(to_pos,cd.from,cd.from_loc);cd.x1=from_pos.x,cd.y1=from_pos.y,cd.x2=to_pos.x,cd.y2=to_pos.y,this.draw()}set_eligible_overlays(){var cd=this.d3object.datum(),d_to=d3.select("#"+cd.to).datum(),d_from=d3.select("#"+cd.from).datum(),dragevent=ormjs.models[cd.model].dragevent,objects=ormjs.models[this.model].objects;"constraint"!=d_from.kind&&(cd.from_loc=dragevent.all_locations,cd.to_loc=dragevent.all_locations,"rolebox"==d_to.kind&&(cd.to_loc=objects.rolebox[cd.to].eligible_locations(d_from.kind,cd.to_loc)),"rolebox"==d_from.kind&&(cd.from_loc=objects.rolebox[cd.from].eligible_locations(d_to.kind,cd.from_loc)))}assign_role(){var d_conn=this.d3object.datum(),d_rolebox=d3.select("#"+d_conn.to).datum(),d_object=d3.select("#"+d_conn.from).datum(),conntypes=ormjs.Connector.supported_types().names,objects=ormjs.models[this.model].objects;if(!d_rolebox||!d_object)return!1;if("rolebox"!=d_rolebox.kind&&"entity"!=d_rolebox.kind){if("connector"!=d_rolebox.kind)return!1;if(d_rolebox.conntype!=conntypes.subtype)return!1}return"entity"==d_rolebox.kind&&"entity"==d_object.kind||("entity"==d_object.kind||"value"==d_object.kind?(d_rolebox.entity=d_conn.from,objects.predicate[d_rolebox.parent].set_subject(),objects.predicate[d_rolebox.parent].update_flip(),d_conn.to_loc=objects.rolebox[d_conn.to].eligible_locations(d_object.kind,d_conn.to_loc),!0):"constraint"==d_object.kind&&("connector"!=d_rolebox.kind&&(conntypes=ormjs.models[d_conn.model].dragevent,d_rolebox=ormjs.Graph.closest_overlay({x:d_conn.x2,y:d_conn.y2},d_conn.to),conntypes={dragevent:conntypes.locations,closest:d_rolebox.location},"role-value"==d_object.type&&(conntypes.dragevent=["top","bottom"]),d_conn.to_loc=objects.rolebox[d_conn.to].eligible_locations(d_object.kind,conntypes),objects.constraint[d_conn.from].propagate_roles()),!0))}flip(){var cd=this.d3object.datum(),cdto=cd.to,cdto=(cd.to=cd.from,cd.from=cdto,[...cd.to_loc]);cd.to_loc=[...cd.from_loc],cd.from_loc=cdto}closest_overlay(){return ormjs.Geometry.line_midpoint(this.d3object.datum())}static all_subtypes(modelID){var connID,subtypes={},conntypes=ormjs.Connector.supported_types().names,connectors=ormjs.models[modelID].objects.connector;for(connID in connectors)connectors[connID].d3object.datum().conntype==conntypes.subtype&&(subtypes[connID]=connectors[connID]);return subtypes}actions(){var id=this.id;this.d3object.on("contextmenu",d3.contextMenu(d=>ormjs.OptionMenu.connector_menu(d,this.model))).on("click",this.remove),d3.select("#o-"+this.id).on("mousedown",event=>{this.mousedown(event,this)}).on("mouseover",d=>{ormjs.Graph.class_as("p-"+id,"conn_mouseover"),ormjs.Graph.class_as("o-"+id,"conn_mouseover")}).on("mouseout",d=>{ormjs.Graph.unclass_as("p-"+id,"conn_mouseover"),ormjs.Graph.unclass_as("o-"+id,"conn_mouseover")})}mousedown(event,connector){event.stopPropagation();var d,conn,conntypes=ormjs.Connector.supported_types().names;connector.d3object.datum().conntype==conntypes.subtype&&2!=event.buttons&&(d=connector.d3object.datum(),event={x:(event=d3.pointer(event))[0]+d.x,y:event[1]+d.y},d={x1:(d=connector.closest_overlay(event)).x,x2:event.x,y1:d.y,y2:event.y,conntype:conntypes.CtoRB,model:connector.model,view:connector.view},(event=(conn=new ormjs.Connector(d)).d3object.datum()).from=connector.id,event.selected=!0,ormjs.models[connector.model].currentview.d3object.on("mousemove",function(event){conn.svg_mousemove(event)}).on("mouseup",function(event){conn.svg_mouseup(event)}))}svg_mousemove(event){var cd=this.d3object.datum(),event=d3.pointer(event,this.d3object.node()),event=(cd.x2=event[0],cd.y2=event[1],ormjs.models[cd.model].dragevent.locations),event=ormjs.Graph.closest_overlay({x:cd.x2,y:cd.y2},cd.from,event),event=(cd.x1=event.x,cd.y1=event.y,d3.select("#p-"+this.id));event.attr("d",null),event.attr("d",d3.line()([[cd.x1,cd.y1],[cd.x2,cd.y2]]))}svg_mouseup(event){var cd=this.d3object.datum(),svg=(cd.selected=!1,ormjs.models[cd.model].currentview.d3object),dragevent=ormjs.models[cd.model].dragevent,svg=(svg.on("mousemove",null).on("mouseup",null),d3.pointer(event,this.d3object.node())),event={x:svg[0],y:svg[1]},svg=ormjs.Graph.closest_object(event,cd.model);svg.found&&svg.distance<svg.tolerance&&svg.object.attr("id")!=cd.from?(cd.to=svg.object.attr("id"),this.connect(),dragevent.locations=dragevent.all_locations):(dragevent.locations=dragevent.all_locations,this.shallow_delete())}static remove(event){if(event.ctrlKey||2==event.buttons){event=event.target.id.toString();try{var connID=ormjs.Graph.get_parentID(event);ormjs.Graph.any_object(connID).delete()}catch(e){if(e instanceof TypeError){console.log("TypeError:",e),console.log("Attempting to force delete object #"+Graph.get_parentID(event));try{d3.select("#"+Graph.get_parentID(event)).remove(),console.log("Success.")}catch(e){console.log("Failed.","Attempting to force delete object #"+event),d3.select("#"+event).remove()}}}}}delete(){this.constraint_connector_delete(),this.simple_delete(),ormjs.models[this.model].update()}simple_delete(){this.detach(),delete ormjs.models[this.model].objects.connector[this.id],this.shallow_delete()}constraint_connector_delete(){var conntypes=ormjs.Connector.supported_types().names,connectors=ormjs.models[this.model].objects.connector,d=this.d3object.datum();d.conntype==conntypes.subtype&&[...d.connectors].map(connID=>{connectors[connID].simple_delete()})}shallow_delete(){this.d3object.remove()}detach(){this.data_propagate(!0)}attach(){this.data_propagate()}data_propagate(detach=!1){var fr,cd=this.d3object.datum(),from_obj=d3.select("#"+cd.from),to_obj=d3.select("#"+cd.to),detach=(null!=from_obj&&(fr=from_obj.datum().connectors,detach?fr=ormjs.GraphUtils.remove_from_array(fr,this.id):fr.push(this.id)),null!=to_obj&&(fr=to_obj.datum().connectors,detach?fr=ormjs.GraphUtils.remove_from_array(fr,this.id):fr.push(this.id)),ormjs.models[this.model].objects.rolebox);"rolebox"==from_obj.datum().kind&&detach[cd.from].bubble_connectors(),"rolebox"==to_obj.datum().kind&&detach[cd.to].bubble_connectors()}static neighbors(objID){return d3.select("#"+objID).datum().connectors.map(connID=>{var connID=d3.select("#"+connID).datum(),connID=connID.from==objID?connID.to:connID.from,parent=d3.select("#"+connID).datum().parent;return connID!=parent?[connID,parent]:connID}).flat().filter(v=>v)}},ormjs.ConnPath=class{static linePath(end){return["M",0,",",0,"L",end,",",0,"Z"].join(" ")}static linePathArrow(end){return["M",0,",",0,"L",end-=6*ormjs.size.connector.stroke,",",0,"Z"].join(" ")}static arrowPath(headRadius,end){var shoulder=end-2*headRadius;return["M",0,",",0,"L",shoulder,",",0,"L",shoulder,",",headRadius,"L",end,",",0,"L",shoulder,",",-headRadius,"L",shoulder,",",0,"M",end,",",0,"Z"].join("")}static constraintArrowPath(end){var headRadius=ormjs.size.connector.wide_stroke;return ormjs.ConnPath.arrowPath(headRadius,end)}static subtypePath(end){var headRadius=2*ormjs.size.connector.stroke,offset=1.5*ormjs.size.connector.stroke;return ormjs.ConnPath.arrowPath(headRadius,end-=offset)}static subtypePathDashed(end){var headRadius=ormjs.size.connector.wide_stroke;return ormjs.ConnPath.arrowPath(headRadius,end)}static mandatoryPath(end){return["M",0,",",0,"L",end,",",0,"M",end,",",0,"m",-5,0,"a",5,",",5,"0 1, 0 ",10,",",0,"a",5,",",5,"0 1, 0 ",-10,",",0,"Z"].join(" ")}},ormjs.HighlightRegion=class{static svg_mousedown(event){var svg,hrect;event.stopPropagation(),2!=event.button&&null!=(svg=ormjs.Graph.any_object(event.target.id.toString()))&&(ormjs.HighlightRegion.unselect_all(svg.id),d3.select("#ormjs-hrect").remove(),event=d3.pointer(event),hrect=svg.d3object.append("rect").datum({x1:event[0],y1:event[1],x2:event[0],y2:event[1]}).attr("class","ormjs-highlight_rect").attr("width","1px").attr("height","1px").attr("x",event[0]).attr("y",event[1]).attr("id","ormjs-hrect"),svg.d3object.on("mousemove",function(event){ormjs.HighlightRegion.mousemove(event,hrect)}).on("mouseup",function(event,d){ormjs.HighlightRegion.mouseup(event,hrect,svg)}))}static mousemove(event,hrect){var event=d3.pointer(event),d=hrect.datum();d.x2=event[0],d.y2=event[1],hrect.attr("width",()=>Math.abs(d.x2-d.x1)).attr("height",()=>Math.abs(d.y2-d.y1)),d.x2<d.x1&&hrect.attr("x",d.x2),d.y2<d.y1&&hrect.attr("y",d.y2)}static mouseup(event,hrect,svg){event.stopPropagation(),ormjs.HighlightRegion.objects_in_range(hrect,svg.model),svg.d3object.on("mousemove",null).on("mouseup",null),hrect.remove()}static objects_in_range(hrect,modelID){var objects=ormjs.models[modelID].objects,rng=hrect.datum();rng.xmin=Math.min(rng.x1,rng.x2),rng.xmax=Math.max(rng.x1,rng.x2),rng.ymin=Math.min(rng.y1,rng.y2),rng.ymax=Math.max(rng.y1,rng.y2),["entity","predicate","value","constraint"].map(obj=>{for(var anyID in objects[obj]){var d=d3.select("#"+anyID).datum();d.x>rng.xmin&&d.x<rng.xmax&&d.y>rng.ymin&&d.y<rng.ymax&&ormjs.Graph.class_as(anyID,"ormjs-selected")}})}static unselect_all(viewID){var viewID=ormjs.Graph.any_object(viewID).objects_in_view(),objlist=d3.selectAll(".ormjs-selected").nodes().map(node=>node.id);viewID.filter(value=>objlist.includes(value)).map(id=>{ormjs.Graph.unclass_as(id,"ormjs-selected")})}static select_all(viewID){ormjs.Graph.any_object(viewID).objects_in_view().map(id=>{ormjs.Graph.class_as(id,"ormjs-selected")})}static drag_selected(event){event={dx:event.dx,dy:event.dy};ormjs.HighlightRegion.move_by_class("ormjs-selected",event)}static move_by_class(classname,position){d3.selectAll("."+classname).nodes().map(obj=>{var d=d3.select("#"+obj.id).datum();d.dx+=position.dx,d.dy+=position.dy,d.x=d.x0+d.dx,d.y=d.y0+d.dy,ormjs.Graph.any_object(obj.id).move()})}},ormjs.Traversal=class{static activate(view){view.objects_in_view().map(objID=>{ormjs.Traversal.actions(objID,view)}),ormjs.Traversal.set_traversal_classes(view)}static deactivate(view){view.objects_in_view().map(objID=>{ormjs.Traversal.reset_actions(objID)}),ormjs.Traversal.unclass_all(view),ormjs.GenerateRel.display_rel(ormjs.models[view.model])}static update(view){view.traversal?ormjs.Traversal.activate(view):ormjs.Traversal.deactivate(view)}static actions(objID,view){var drag_event=d3.drag().on("start",null).on("drag",null).on("end",null);d3.select("#"+objID).on("dblclick",null).on("contextmenu",null).on("click",()=>{ormjs.Traversal.flip_selected(objID,view)}).call(drag_event),"predicate"==ormjs.Graph.object_kind(objID)?d3.select("#"+objID).datum().boxes.map(boxID=>{d3.select("#"+boxID).on("contextmenu",null),ormjs.Graph.class_as("o-"+boxID,"ormjs-toverlay")}):ormjs.Graph.class_as("o-"+objID,"ormjs-toverlay")}static reset_actions(objID){ormjs.Graph.any_object(objID).actions(),"predicate"==ormjs.Graph.object_kind(objID)?d3.select("#"+objID).datum().boxes.map(boxID=>{ormjs.Graph.any_object(boxID).actions(),ormjs.Graph.unclass_as("o-"+boxID,"ormjs-toverlay")}):ormjs.Graph.unclass_as("o-"+objID,"ormjs-toverlay")}static flip_selected(objID,view){d3.select("#"+objID).classed("ormjs-tselected")?ormjs.Traversal.unselect(objID):ormjs.Traversal.select(objID),ormjs.Traversal.set_traversal_classes(view),ormjs.Traversal.highlighted_facts(view)}static simple_select(objID){ormjs.Graph.unclass_as(objID,"ormjs-thidden"),ormjs.Graph.unclass_as(objID,"ormjs-tneighbor"),ormjs.Graph.class_as(objID,"ormjs-tselected")}static select(objID){ormjs.Traversal.simple_select(objID),ormjs.Traversal.unclass_connectors(objID,"ormjs-thidden"),ormjs.Traversal.class_connectors(objID,"ormjs-tneighbor");var nodes=ormjs.Entity.nearest_neighbors(objID);nodes.selected=d3.selectAll(".ormjs-tselected").nodes().map(node=>node.id),nodes.nonterminal=nodes.nonterminal.filter(value=>!nodes.selected.includes(value)),nodes.terminal=nodes.terminal.filter(value=>!nodes.selected.includes(value)),nodes.nonterminal.map(nnID=>{ormjs.Graph.unclass_as(nnID,"ormjs-thidden"),ormjs.Traversal.unclass_connectors(nnID,"ormjs-thidden"),ormjs.Graph.class_as(nnID,"ormjs-tneighbor"),ormjs.Traversal.class_connectors(nnID,"ormjs-tneighbor")}),nodes.terminal.map(nnID=>{ormjs.Graph.unclass_as(nnID,"ormjs-thidden"),ormjs.Graph.class_as(nnID,"ormjs-tneighbor")}),ormjs.Traversal.select_predicates(nodes)}static unselect(objID){ormjs.Graph.unclass_as(objID,"ormjs-tselected"),ormjs.Graph.class_as(objID,"ormjs-tneighbor")}static class_connectors(objID,classname){d3.select("#"+objID).datum().connectors.map(connID=>{ormjs.Graph.class_as(connID,classname)})}static unclass_connectors(objID,classname){d3.select("#"+objID).datum().connectors.map(connID=>{ormjs.Graph.unclass_as(connID,classname)})}static select_predicates(nodes){nodes.nonterminal.map(nnID=>{nnID.includes("predicate")&&ormjs.Graph.any_object(nnID).role_players().every(rpID=>d3.select("#"+rpID).classed("ormjs-tselected"))&&ormjs.Traversal.simple_select(nnID)})}static unclass_all(view){var in_view=view.objects_in_view();["ormjs-tneighbor","ormjs-tselected","ormjs-thidden"].map(cls=>{d3.selectAll("."+cls).nodes().map(node=>node.id).filter(value=>in_view.includes(value)).map(objID=>{ormjs.Graph.unclass_as(objID,cls),ormjs.Traversal.unclass_connectors(objID,cls)})})}static set_traversal_classes(view){var in_view=view.objects_in_view(),selected=d3.selectAll(".ormjs-tselected").nodes().map(node=>node.id);0==selected.filter(value=>in_view.includes(value)).length?in_view.map(objID=>{ormjs.Graph.unclass_as(objID,"ormjs-thidden"),ormjs.Traversal.unclass_connectors(objID,"ormjs-thidden"),ormjs.Graph.class_as(objID,"ormjs-tneighbor"),ormjs.Traversal.class_connectors(objID,"ormjs-tneighbor")}):(in_view.filter(value=>!selected.includes(value)).map(objID=>{ormjs.Graph.class_as(objID,"ormjs-thidden"),ormjs.Traversal.class_connectors(objID,"ormjs-thidden")}),selected.map(objID=>{ormjs.Traversal.select(objID)}))}static highlighted_facts(view){var factID,metamodel=ormjs.models[view.model].metamodel,predicates=ormjs.Traversal.highlighted_predicates(view),factmap={};for(factID in metamodel.Fact)factmap[metamodel.Fact[factID]._rbgID]=factID;predicates=predicates.map(predID=>metamodel.Fact[factmap[predID]].ReadingOrder[0].Reading[0]._Statement).filter(v=>v);return ormjs.Traversal.publish_statements(predicates,view),predicates}static publish_statements(statements,view){null!=view.traversal_target&&(statements=statements.join("</p><p>"),d3.select("#"+view.traversal_target).html(`<p>${statements}</p>`))}static highlighted_predicates(view){var in_view=view.objects_in_view();return console.log("in_view",in_view),d3.selectAll(".ormjs-tselected").nodes().map(node=>node.id).filter(value=>in_view.includes(value)).map(sID=>{if(sID.includes("predicate"))return sID}).filter(v=>v)}},ormjs.PNG=class{static download(event,viewID,URItarget){ormjs.InlineStyle.add(viewID),ormjs.PNG.set_svg_dimensions(viewID);var svg=d3.select("#"+viewID),canvas=document.getElementById("hc-"+viewID),png_trigger=(null==canvas&&(ormjs.PNG.create_hidden_canvas(viewID),canvas=document.getElementById("hc-"+viewID)),canvas.setAttribute("width",svg.attr("width")),canvas.setAttribute("height",svg.attr("height")),canvas.getAttribute("trigger"));ormjs.PNG.to_canvas(viewID,"hc-"+viewID).addEventListener("load",function(){var imgURI;"true"==png_trigger?(imgURI=canvas.toDataURL("image/png").replace("image/png","image/octet-stream"),d3.select("#"+URItarget).attr("href",imgURI),imgURI=event.target.id.toString(),document.getElementById(imgURI).dispatchEvent(event)):d3.select("#"+URItarget).attr("href",null)}),ormjs.InlineStyle.remove(viewID),ormjs.PNG.unset_svg_dimensions(viewID),png_trigger="true"==png_trigger?"false":"true",canvas.setAttribute("trigger",png_trigger)}static to_canvas(viewID,canvasID){var ctx=document.getElementById(canvasID).getContext("2d"),canvasID=(new XMLSerializer).serializeToString(d3.select("#"+viewID).node()),DOMURL=window.URL||window.webkitURL||window,img=new Image,viewID=new Blob([canvasID],{type:"image/svg+xml;base64"}),url=DOMURL.createObjectURL(viewID);return img.src=url,img.onload=function(){ctx.drawImage(img,0,0),DOMURL.revokeObjectURL(url)},img}static trigger_click_event(id){var evt=new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0});document.getElementById(id).dispatchEvent(evt)}static create_hidden_canvas(viewID){var parentID=ormjs.GraphUtils.parent_node_id(viewID);d3.select("#"+parentID).append("div").attr("class","ormjs-hidden-canvas-container").append("canvas").attr("trigger","false").attr("class","ormjs-hidden-canvas").attr("id","hc-"+viewID)}static set_svg_dimensions(viewID){var svgparent=ormjs.GraphUtils.parent_node_id(viewID),cnvsw=document.getElementById(svgparent).offsetWidth,svgparent=3e3*(document.getElementById(svgparent).offsetHeight/cnvsw);d3.select("#"+viewID).attr("width",3e3).attr("height",svgparent)}static unset_svg_dimensions(viewID){d3.select("#"+viewID).attr("width","100%").attr("height","100%")}},ormjs.OptionMenu=class{static duplicate_action(event,objects){event=event.target.id.toString(),objects=objects[ormjs.Graph.get_parentID(event)];null!=objects&&objects.duplicate()}static conditional_label(event,objects,name,check){event=event.target.id.toString(),objects=objects[ormjs.Graph.get_parentID(event)];return ormjs.OptionMenu.check_label(objects,name,check)}static check_label(obj,name,check){return null!=obj&&obj.d3object.datum()[check]?name+" &nbsp;&nbsp;&#x2713;":name}static select_label(event,objects){event=event.target.id.toString(),objects=objects[ormjs.Graph.get_parentID(event)];return null!=objects&&objects.d3object.classed("ormjs-selected")?"Select &nbsp;&nbsp;&#x2713;":"Select"}static select_action(event,objects){event=event.target.id.toString(),objects=objects[ormjs.Graph.get_parentID(event)];null!=objects&&(objects.d3object.classed("ormjs-selected")?ormjs.Graph.unclass_as(objects.id,"ormjs-selected"):ormjs.Graph.class_as(objects.id,"ormjs-selected"))}static svg_menu(view){return[{title:"Entity",action:function(d,event){event=d3.pointer(event,event.target);new ormjs.Entity({x:event[0],y:event[1],view:view.id})}},{title:"Fact",action:function(d,event){event=d3.pointer(event,event.target);new ormjs.Predicate({x:event[0],y:event[1],view:view.id})}},{title:"Value",action:function(d,event){event=d3.pointer(event,event.target);new ormjs.Value({x:event[0],y:event[1],view:view.id})}},{title:"Constraint",action:function(d,event){event=d3.pointer(event,event.target);new ormjs.Constraint({x:event[0],y:event[1],view:view.id})}},{divider:!0},{title:"Select All",action:function(d,event){ormjs.HighlightRegion.select_all(d.id)}}]}static object_menu(objects){return[{title:"Duplicate",action:function(d,event){ormjs.OptionMenu.duplicate_action(event,objects)}},{title:function(d,event){return ormjs.OptionMenu.select_label(event,objects)},action:function(d,event){ormjs.OptionMenu.select_action(event,objects)}},{title:"Properties",action:function(d,event){ormjs.PropertyMenu.popup_event(event)}},{divider:!0},{title:"Delete",action:function(d,event){ormjs.Graph.remove(event)}}]}static entity_menu(modelID){modelID=ormjs.models[modelID].objects.entity;return ormjs.OptionMenu.object_menu(modelID)}static value_menu(modelID){modelID=ormjs.models[modelID].objects.value;return ormjs.OptionMenu.object_menu(modelID)}static constraint_menu(modelID){modelID=ormjs.models[modelID].objects.constraint;return ormjs.OptionMenu.object_menu(modelID)}static rolebox_menu(modelID){var objects=ormjs.models[modelID].objects;return[{title:function(d,event){event=event.target.id.toString(),event=ormjs.Graph.levelupID(event),event=objects.rolebox[event];return ormjs.OptionMenu.check_label(event,"Mandatory","mandatory")},action:function(d,event){event=event.target.id.toString(),event=ormjs.Graph.levelupID(event),event=objects.rolebox[event];null!=event&&event.flip_mandatory()}},{title:"Uniqueness Constraint",action:function(d,event){ormjs.PropertyMenu.popup_event(event)}},{divider:!0},{title:function(d,event){return ormjs.OptionMenu.conditional_label(event,objects.predicate,"Rotate","rotated")},action:function(d,event){event=event.target.id.toString(),event=objects.predicate[ormjs.Graph.get_parentID(event)];null!=event&&event.rotate()}},{title:function(d,event){return ormjs.OptionMenu.conditional_label(event,objects.predicate,"Flip","flipped")},action:function(d,event){event=event.target.id.toString(),event=objects.predicate[ormjs.Graph.get_parentID(event)];null!=event&&event.flip()}},{title:"Duplicate",action:function(d,event){ormjs.OptionMenu.duplicate_action(event,objects.predicate)}},{title:function(d,event){return ormjs.OptionMenu.select_label(event,objects.predicate)},action:function(d,event){ormjs.OptionMenu.select_action(event,objects.predicate)}},{title:"Properties",action:function(d,event){ormjs.PropertyMenu.popup_event(event)}},{divider:!0},{title:"Add Rolebox",action:function(d,event){event=event.target.id.toString(),event=objects.predicate[ormjs.Graph.get_parentID(event)];null!=event&&event.add_rolebox()}},{title:"Delete Last Rolebox",action:function(d,event){var boxes,event=event.target.id.toString(),event=objects.predicate[ormjs.Graph.get_parentID(event)];null!=event&&(boxes=[...event.d3object.datum().boxes],event.d3object.datum().flipped&&boxes.reverse(),objects.rolebox[boxes[boxes.length-1]].delete())}},{title:"Delete Fact",action:function(d,event){event=event.target.id.toString(),event=objects.predicate[ormjs.Graph.get_parentID(event)];null!=event&&event.delete()}}]}static connector_menu(d,modelID){return"subtype"==d.conntype?(d=ormjs.models[modelID].objects.connector,ormjs.OptionMenu.connOptions_subtype(d)):ormjs.OptionMenu.connOptions_default}static connOptions_default=[{title:"Delete",action:function(d,event){ormjs.Connector.remove(event)}}];static connOptions_subtype(connectors){return[{title:function(d,event){event=event.target.id.toString(),event=connectors[ormjs.Graph.get_parentID(event)];return null!=event&&event.d3object.datum().preferred?"Preferred Identifier &nbsp;&nbsp;&#x2713;":"Preferred Identifier"},action:function(d,event){event=event.target.id.toString(),event=connectors[ormjs.Graph.get_parentID(event)];null!=event&&((d=event.d3object.datum()).preferred?d.preferred=!1:d.preferred=!0,event.draw())}},{title:"Delete",action:function(d,event){ormjs.Connector.remove(event)}}]}},ormjs.propmenu={},ormjs.propmenu.open_popups=[],ormjs.propmenu.formfields={entity:["name","refmode","independent","rtpopular","rtgeneral","rtunit"],value:["name","independent"],rolebox:["name"],predicate:["rname"],constraint:["type","content"]},ormjs.propmenu.allowed_empty_fields={entity:["independent","refmode"],value:["independent"],rolebox:[],predicate:["rname"],constraint:["content"]},ormjs.PropertyMenu=class{static draw_popup(object){var svg,popwidth,popheight,popfun={entity:function(){return ormjs.PropertyMenu.entity_form(object)},predicate:function(){return ormjs.PropertyMenu.fact_form(object)},value:function(){return ormjs.PropertyMenu.value_form(object)},constraint:function(){return ormjs.PropertyMenu.constraint_form(object)}};object.datum().kind in popfun&&d3.select("#pop-"+object.attr("id")).empty()&&(svg=ormjs.Graph.any_object(object.datum().view).d3object,popwidth=ormjs.size.popup.width,popheight=ormjs.size.popup.height,(svg=svg.append("g").datum({x:-popwidth/2,y:-popheight/2}).attr("class","ormjs-popup_group").attr("id","pop-"+object.attr("id")).attr("x",0).attr("y",0).attr("width",popwidth).attr("height",popheight).attr("transform",ormjs.Graph.translate(-popwidth/2,-popheight/2))).append("rect").attr("class","ormjs-popup").attr("x",0).attr("y",0).attr("width",popwidth).attr("height",popheight),svg.append("foreignObject").attr("class","ormjs-popup").attr("width",popwidth).attr("height",popheight).append("xhtml:div").attr("class","ormjs-popup_content").html(()=>popfun[object.datum().kind]()),popwidth="name-"+object.attr("id"),"predicate"==object.datum().kind&&(ormjs.PropertyMenu.popup_rbgroup(object),popwidth="name-r-0-"+object.attr("id")),"constraint"==object.datum().kind&&(ormjs.PropertyMenu.popup_constraint(object),popwidth=null),ormjs.PropertyMenu.append_submit(svg,object),ormjs.PropertyMenu.append_close(svg,object),popheight=d3.drag().on("start",ormjs.PropertyMenu.dragstarted).on("drag",ormjs.PropertyMenu.dragged).on("end",ormjs.PropertyMenu.dragended),svg.on("dblclick",event=>{event.stopPropagation()}).on("contextmenu",event=>{event.stopPropagation()}).call(popheight),ormjs.PropertyMenu.no_drag_fields(object),null!=popwidth&&document.getElementById(popwidth).focus(),ormjs.propmenu.open_popups.push(svg))}static append_close(popup,object){var xsize=ormjs.size.popup.close,xmarg=1.2*xsize,xpos={x:ormjs.size.popup.width-xmarg,y:xmarg};popup.append("path").attr("d",()=>ormjs.PropertyMenu.xPath(xpos,xsize)).attr("class","ormjs-xclose").attr("id","xpop-"+object.attr("id")),d3.select("#xpop-"+object.attr("id")).on("click",ormjs.PropertyMenu.close_popup)}static append_submit(popup,object){var popwidth=ormjs.size.popup.width,popheight=ormjs.size.popup.height,stroke_sz=ormjs.size.popup.stroke,stroke_sz_h=ormjs.size.popup.hover_stroke,chsize=ormjs.size.popup.check,xmarg=ormjs.size.popup.close,chmarg={x:chsize.x/2-chsize.m,y:chsize.m,ex:2*xmarg,ey:xmarg},chpos={x:popwidth-chmarg.ex-chsize.x,y:popheight-chmarg.ey-chsize.y};popup.append("g").attr("id","submit-"+object.attr("id")).attr("x",popwidth-chmarg.ex).attr("y",popheight-chmarg.ey),d3.select("#submit-"+object.attr("id")).append("rect").attr("id","#submit-r-"+object.attr("id")).attr("class","ormjs-submit_svg").attr("x",chpos.x).attr("y",chpos.y).attr("width",chsize.x+2*chmarg.x).attr("height",chsize.y+2*chmarg.y),d3.select("#submit-"+object.attr("id")).append("path").attr("d",()=>ormjs.PropertyMenu.checkPath(chpos,chsize,chmarg)).attr("class","ormjs-spath").attr("id","spop-"+object.attr("id")).attr("stroke-width",stroke_sz),d3.select("#submit-"+object.attr("id")).on("mouseover",()=>{d3.select("#spop-"+object.attr("id")).attr("stroke-width",stroke_sz_h).attr("stroke-opacity",1)}).on("mouseout",()=>{d3.select("#spop-"+object.attr("id")).attr("stroke-width",stroke_sz).attr("stroke-opacity",.6)}).on("click",()=>ormjs.PropertyMenu.update_object(object))}static xPath(position,size){size/=2;return["M",position.x-size,",",position.y+size,"L",position.x+size,",",position.y-size,"M",position.x-size,",",position.y-size,"L",position.x+size,",",position.y+size,"Z"].join("")}static checkPath(position,size,margin){return["M",position.x+size.x+margin.x,",",position.y+margin.y,"L",position.x+(size.x+margin.x)/2,",",size.y+position.y+margin.y/2,"L",position.x+margin.x,",",position.y+(size.y+margin.y)/1.7,"M",position.x+size.x,",",position.y+margin.y,"Z"].join("")}static popup_event(event,d){event.stopPropagation();event=event.target.id.toString(),event=ormjs.Graph.get_parentID(event);ormjs.PropertyMenu.draw_popup(d3.select("#"+event))}static dragstarted(event){event.sourceEvent.stopPropagation(),d3.select(this).style("cursor","grabbing")}static dragged(event,d){d.x+=event.dx,d.y+=event.dy,d3.select(this).attr("transform",ormjs.Graph.translate(d.x,d.y))}static dragended(event){d3.select(this).style("cursor","grab")}static close_popup(event,d){var xID=d3.select(this).attr("id"),xID=xID.substring(1,xID.length);ormjs.PropertyMenu.remove_popup(d3.select("#"+xID))}static remove_popup(popup){var popwidth=ormjs.size.popup.width,popheight=ormjs.size.popup.height,d=popup.datum(),popwidth=d.x+popwidth/2,d=d.y+popheight/2;ormjs.propmenu.open_popups=ormjs.GraphUtils.remove_from_array(ormjs.propmenu.open_popups,popup),popup.transition().duration(600).attr("transform","translate("+popwidth+","+d+") scale(0)").remove()}static remove_all_popups(viewID,_callback){var popup_groups=d3.select("#"+viewID).selectAll(".popup_group");for(k in popup_groups.nodes()){var popID=popup_groups.nodes()[k].id;d3.select("#"+popID).remove()}_callback()}static no_drag_fields(object){var drag_form=d3.drag().on("start",event=>{event.sourceEvent.stopPropagation()}),formIDs=ormjs.propmenu.formfields[object.datum().kind];for(n in formIDs)d3.select("#"+formIDs[n]+"-"+object.attr("id")).call(drag_form);if("predicate"==object.datum().kind){var n,boxes=[...object.datum().boxes];for(n in delete boxes[1],boxes)d3.select("#name-"+boxes[n]).call(drag_form);d3.select("#popsvg-"+object.attr("id")).call(drag_form)}d3.select("#xpop-"+object.attr("id")).call(drag_form),d3.select("#submit-"+object.attr("id")).call(drag_form)}static enter_last_popup(){var popup=ormjs.propmenu.open_popups[ormjs.propmenu.open_popups.length-1],objID=popup.attr("id").substring(4,popup.attr("id").length),objID=d3.select("#"+objID);ormjs.PropertyMenu.update_object(objID),ormjs.propmenu.open_popups=ormjs.GraphUtils.remove_from_array(ormjs.propmenu.open_popups,popup)}static update_object(object){var constID;ormjs.PropertyMenu.update_fields(object),"predicate"==object.datum().kind&&(ormjs.PropertyMenu.update_rolebox_fields(object),ormjs.PropertyMenu.set_rbgroup_uconstraints(object)),"constraint"==object.datum().kind&&(constID=object.attr("id"),ormjs.models[object.datum().model].objects.constraint[constID].redraw()),ormjs.PropertyMenu.update_name(object),ormjs.PropertyMenu.remove_popup(d3.select("#pop-"+object.attr("id"))),ormjs.models[object.datum().model].update()}static update_fields(object){var n,formIDs=ormjs.propmenu.formfields[object.datum().kind],allowedEmptyIDs=ormjs.propmenu.allowed_empty_fields[object.datum().kind],d=object.datum();for(n in formIDs){var field=d3.select(`#${formIDs[n]}-`+object.attr("id")),fieldval=field.property("value"),fieldkey=field.property("name");"checkbox"==field.property("type")&&(fieldval=field.property("checked")),((fieldval="radio"!=field.property("type")||field.property("checked")?fieldval:!1)||allowedEmptyIDs.includes(formIDs[n]))&&(d[fieldkey]=fieldval)}}static update_rolebox_fields(object){var boxes=[...object.datum().boxes];if(object.datum().flipped&&boxes.reverse(),1==boxes.length&&ormjs.PropertyMenu.update_fields(d3.select("#"+boxes[0])),1<boxes.length&&(object=d3.select("#name-"+boxes[0]).property("value"),object=ormjs.PropertyMenu.split_role_name(object),d3.select("#"+boxes[0]).datum().name=object[0],d3.select("#"+boxes[1]).datum().name=object[1]),2<boxes.length){var n,rng=ormjs.GraphUtils.range(boxes.length-2,2);for(n in rng)ormjs.PropertyMenu.update_fields(d3.select("#"+boxes[rng[n]]))}}static set_rbgroup_uconstraints(rbgroup){var predicates=ormjs.models[rbgroup.datum().model].objects.predicate,rbg=d3.select("#pop-rbg-"+rbgroup.attr("id"));if(rbg.classed("ormjs-notparsed"))rbg.remove();else{var n,popboxes=rbg.datum().boxes,boxes=[...rbgroup.datum().boxes],rotate=(rbgroup.datum().flipped&&boxes.reverse(),!1);for(n in rbgroup.datum().rotated&&(rotate=!0,predicates[rbgroup.attr("id")].rotate()),boxes){var rbox=d3.select("#"+boxes[n]);rbox.datum().multiplicity=d3.select("#"+popboxes[n]).datum().multiplicity,ormjs.Rolebox.set_rolebox_iuc(rbox)}rotate&&predicates[rbgroup.attr("id")].rotate(),rbg.remove()}}static split_role_name(namestring){var names=namestring.split(" ");return 1==names.length?[namestring,""]:2==names.length?names:[names.splice(0,names.length-1).join(" "),names[names.length-1]]}static update_name(object){var objects=ormjs.models[object.datum().model].objects,kind=object.datum().kind;["entity","value","predicate"].includes(kind)&&objects[kind][object.attr("id")].update_display_name()}static entity_form(entity){var d=entity.datum(),entity=entity.attr("id"),entities=ormjs.models[d.model].objects.entity,ch="",entities=(d.independent&&(ch='checked="checked"'),entities[entity].check_independence()||(ch+=' disabled="disabled"'),{popular:"",general:"",unit:""});return entities[d.reftype]='checked="checked"',`
        <div class="ormjs-popup_form">
        <h1>Entity</h1>
            <table class="form_table">
            <tr>
            <!-- Name -->
            <td class="ormjs-popup-left_col"><label for="fname">Name</label></td>
            <td class="ormjs-popup-right_col"><input type="text" id="name-${entity}" name="name" value="${d.name}" ${focus} /></td>
            </tr>
            <tr>
            <!-- Independent ? -->
            <td class="ormjs-popup-left_col"></td>
            <td class="ormjs-popup-right_col_small"><input type="checkbox" id="independent-${entity}" name="independent" value="${d.independent}" ${ch} />Independent</td>
            </tr>
            <tr>
            <!-- Reference Mode -->
            <td class="ormjs-popup-left_col"><label for="lname">Ref. mode</label></td>
            <td class="ormjs-popup-right_col"><input type="text" id="refmode-${entity}" name="refmode" value="${d.refmode}" /></td>
            </tr>
            <tr>
            <!-- Reference Type -->
            <td class="ormjs-popup-left_col"></td>
            <td class="ormjs-popup-right_col_small">
            <input type="radio" id="rtpopular-${entity}" name="reftype" value="popular" ${entities.popular}>Popular
            <input type="radio" id="rtunit-${entity}" name="reftype" value="unit" ${entities.unit}>Unit
            <input type="radio" id="rtgeneral-${entity}" name="reftype" value="general" ${entities.general}>General
            </td>
            </tr>
            </table>
        </div>
        `}static value_form(value){var d=value.datum(),value=value.attr("id"),values=ormjs.models[d.model].objects.value,ch="";return d.independent&&(ch='checked="checked"'),values[value].check_independence()||(ch+=' disabled="disabled"'),`
        <div class="ormjs-popup_form">
        <h1>Value</h1>
            <table class="form_table">
            <tr>
            <td class="ormjs-popup-left_col"><label for="fname">Name</label></td>
            <td class="ormjs-popup-right_col"><input type="text" id="name-${value}" name="name" value="${d.name}" /></td>
            </tr>
            <tr>
            <!-- Independent ? -->
            <td class="ormjs-popup-left_col"></td>
            <td class="ormjs-popup-right_col_small"><input type="checkbox" id="independent-${value}" name="independent" value="${d.independent}" ${ch} />Independent</td>
            </tr>
            </table>
        </div>
        `}static fact_form(rbgroup){var gd=rbgroup.datum(),boxes=[...gd.boxes],d=(gd.flipped&&boxes.reverse(),d3.select("#"+boxes[0]).datum()),rname=d.name,form_html=(1<boxes.length&&0<(d=d3.select("#"+boxes[1]).datum()).name.length&&(rname+=" "+d.name),`
        <div class="ormjs-popup_form">
        <h1>Fact</h1>
            <table class="form_table">
            <tr>
            <td class="ormjs-popup-left_col"><label for="fname">Name</label></td>
            <td class="ormjs-popup-right_col"><input type="text" id="name-${boxes[0]}" name="name" value="${rname}" /></td>
            </tr>`);if(2<boxes.length){var n,rng=ormjs.GraphUtils.range(boxes.length-2,2);for(n in rng)d=d3.select("#"+boxes[rng[n]]).datum(),form_html+=`<tr>
                <td class="ormjs-popup-left_col"><label for="lname">...</label></td>
                <td class="ormjs-popup-right_col"><input type="text" id="name-${boxes[rng[n]]}" name="name" value="${d.name}" /></td>
                </tr>`}form_html+=`
            <tr>
            <td class="ormjs-popup-left_col"><label for="fname">Rev. Name</label></td>
            <td class="ormjs-popup-right_col"><input type="text" id="rname-${rbgroup.attr("id")}" name="rname" value="${gd.rname}" /></td>
            </tr>`;rname=(boxes.length+1)*ormjs.size.rolebox.width,gd=2*ormjs.size.rolebox.height;return form_html=form_html+`
            <tr>
            <td colspan="2" class="ormjs-centered"><label>Uniqueness Constraints</label></td>
            </tr>
            <tr>
            <td colspan="2" class="ormjs-centered"><svg id="${"popsvg-"+rbgroup.attr("id")}" width="${rname}" height="${gd}"></svg></td>
            </tr>
            `+`
            </table>
        </div>
        `}static popup_rbgroup(rbgroup){var x=ormjs.size.rolebox.width,y=1.2*ormjs.size.rolebox.height,rbgID="pop-rbg-"+rbgroup.attr("id");if(!d3.select("#popsvg-"+rbgroup.attr("id")).empty()){var n,rbg=d3.select("#popsvg-"+rbgroup.attr("id")).append("g").datum({x:x,y:y,dx:0,dy:0,x0:x,y0:y,boxes:[]}).attr("class","ormjs-predicate_prototype ormjs-poprbg").attr("id",rbgID).attr("x",-ormjs.size.rolebox.width/2).attr("y",-ormjs.size.rolebox.height/2),boxes=[...rbgroup.datum().boxes];for(n in rbgroup.datum().flipped&&boxes.reverse(),boxes){var d3rbox=ormjs.Rolebox.draw_box({predicate:{d3object:rbg}});d3rbox.datum().multiplicity=d3.select("#"+boxes[n]).datum().multiplicity,d3rbox.datum().uclist=ormjs.PropertyMenu.available_uconstraints(n,boxes.length),ormjs.Rolebox.set_rolebox_iuc(d3rbox),d3rbox.on("click",ormjs.PropertyMenu.rotate_uconstraint)}ormjs.PropertyMenu.allowed_uc_combination(rbg)}}static rotate_uconstraint(event,d){var rbox=d3.select(this),ind=d.uclist.indexOf(d.multiplicity);d.multiplicity=d.uclist[(ind+1)%d.uclist.length],ormjs.Rolebox.set_rolebox_iuc(rbox),ormjs.PropertyMenu.allowed_uc_combination(d3.select("#"+rbox.datum().parent))}static available_uconstraints(n,total){var mult_param=ormjs.Rolebox.multiplicity(),av=[];return n<total-1&&1<total&&(av=0==n?[mult_param.none,mult_param.one,mult_param.many]:[mult_param.none,mult_param.one,mult_param.many,mult_param.skip]),n==total-1&&(av=[mult_param.none,mult_param.one,mult_param.many]),av=1==total?[mult_param.none,mult_param.one]:av}static allowed_uc_combination(rbg){var n,rbgID=rbg.attr("id"),boxes=[...rbg.datum().boxes],uclist=[];for(n in boxes)uclist.push(d3.select("#"+boxes[n]).datum().multiplicity);var rbg={},mult_param=ormjs.Rolebox.multiplicity(),total=(rbg[mult_param.none]=0,rbg[mult_param.one]=0,rbg[mult_param.many]=0,rbg[mult_param.skip]=0,rbg=uclist.reduce(function(acc,curr){return acc[curr]?++acc[curr]:acc[curr]=1,acc},rbg),boxes.length);0<rbg[mult_param.many]&&rbg[mult_param.many]<total-1||0<rbg[mult_param.one]&&rbg[mult_param.one]<total-1||0<rbg[mult_param.skip]&&0<rbg[mult_param.none]||1<rbg[mult_param.skip]||0<rbg[mult_param.many]&&rbg[mult_param.many]!=total&&2==total?ormjs.Graph.class_as(rbgID,"ormjs-notparsed"):ormjs.Graph.unclass_as(rbgID,"ormjs-notparsed")}static constraint_form(d3constraint){var d=d3constraint.datum(),popwidth=ormjs.size.popup.width,popheight=ormjs.size.popup.height,d3constraint=d3constraint.attr("id"),popheight=.6*popheight,form_html=`
        <div class="ormjs-popup_form">
        <h1>Constraint</h1>
            <table class="form_table">
            <tr>
            <td class="ormjs-popup-left_col"><label for="fname">Type</label></td>
            <td class="ormjs-popup-right_col"><input type="text" id="type-${d3constraint}" 
                name="type" value="${d.type}" lastvalue="${d.type}" readonly disabled /></td>
            </tr>
            `;return form_html+`<tr id="value-row-${d3constraint}" class="value-row">
            <td class="ormjs-popup-left_col"><label for="fcontent">Value</label></td>
            <td class="ormjs-popup-right_col"><input type="text" id="content-${d3constraint}" 
                name="content" value="${d.content}" /></td>
            </tr>
            <tr id="helper-row-${d3constraint}" class="value-row">
            <!-- Helper -->
            <td class="ormjs-popup-left_col"></td>
            <td class="ormjs-popup-right_col_small ormjs-warning">Ex: "1.5", ">=2", "[1..10)", "1..5"</td>
            </tr>
        `+`
            <tr>
                <td colspan="2" class="ormjs-centered">
                <div height="${popheight}" style="overflow-y:auto">
                <svg id="${"popsvg-"+d3constraint}" width="${.8*popwidth}" height="${popheight}" class="ormjs-popsvg"></svg>
                </div>
                </td>
            </tr>
            </table>
        </div>
        `}static popup_constraint(d3constraint){var current_type,d,str,typeiter,dx,w,supported,n,m,p,drag_form,id=d3constraint.attr("id");d3.select("#popsvg-"+id).empty()||(current_type=d3constraint.datum().type,ormjs.PropertyMenu.contraint_value_viz(id,current_type),d=2*ormjs.size.constraint.radius,str=ormjs.size.constraint.stroke,typeiter={},dx=.25*d,w=1.5*d,supported=ormjs.Constraint.supported_types().list,d3constraint=Math.ceil(supported.length/4),d3.select("#popsvg-"+id).attr("width",4*(2*dx+w)).attr("height",(2*dx+w)*d3constraint),m=-1,p=n=0,supported.map(type=>{0==(p=n%4)&&(m+=1),typeiter[type]={x:dx+(2*dx+w)*p,y:dx+(2*dx+w)*m},n+=1}),supported.map(type=>{var pos=typeiter[type],co_id=`pop-cg-${id}-`+type,content="subset"==type?"⊆":"external-frequency"!=type&&"internal-frequency"!=type?"":">2",content=d3.select("#popsvg-"+id).append("g").datum({x:pos.x,y:pos.y,dx:pos.x,dy:pos.y,x0:0,y0:0,content:content,selected:!1,connectors:[],kind:"constraint",type:type,deontic:!1}).attr("class","ormjs-constraint_prototype ormjs-poprbg").attr("width",d).attr("height",d).attr("id",co_id),mark_current=type==current_type?" selected":"";content.append("rect").attr("class","ormjs-constraint_box"+mark_current).attr("id","r-"+co_id).attr("width",w).attr("height",w).attr("transform",()=>ormjs.Graph.translate(-w/2,-w/2)),ormjs.Constraint.draw_constraint(content),d3.select(`#pop-cg-${id}-`+type).attr("transform",()=>ormjs.Graph.translate(pos.x+w/2+str,pos.y+w/2+str))}),drag_form=d3.drag().on("start",event=>{event.sourceEvent.stopPropagation()}),supported.map(type=>{type=(" "+type).slice(1);d3.select(`#pop-cg-${id}-`+type).on("mouseover",event=>{event=event.target.id.toString();null!=event&&(event=ormjs.Graph.levelupID(event),ormjs.Graph.class_as("r-"+event,"hovered"),document.getElementById("type-"+id).lastvalue=document.getElementById("type-"+id).value,document.getElementById("type-"+id).value=d3.select("#"+event).datum().type)}).on("mouseout",event=>{event=event.target.id.toString();null!=event&&(event=ormjs.Graph.levelupID(event),ormjs.Graph.unclass_as("r-"+event,"hovered"),document.getElementById("type-"+id).value=document.getElementById("type-"+id).lastvalue)}).on("click",event=>{event=event.target.id.toString();null!=event&&(event=ormjs.Graph.levelupID(event),supported.map(t=>{ormjs.Graph.unclass_as(`r-pop-cg-${id}-`+t,"selected")}),ormjs.Graph.class_as("r-"+event,"selected"),document.getElementById("type-"+id).value=d3.select("#"+event).datum().type,document.getElementById("type-"+id).lastvalue=document.getElementById("type-"+id).value,ormjs.PropertyMenu.contraint_value_viz(id,d3.select("#"+event).datum().type))}).call(drag_form)}),document.getElementById("content-"+id).oninput=function(){var chk=ormjs.Constraint.valid_frequency_content(document.getElementById("content-"+id).value);document.getElementById("helper-row-"+id).style.display=chk?"none":"table-row"})}static contraint_value_viz(id,type){document.getElementById("value-row-"+id).style.display="none",document.getElementById("helper-row-"+id).style.display="none","external-frequency"!=type&&"internal-frequency"!=type||(document.getElementById("value-row-"+id).style.display="table-row",document.getElementById("content-"+id).focus()),"subset"!=type&&"⊆"==document.getElementById("content-"+id).value&&(document.getElementById("content-"+id).value="")}},ormjs.EntityType=class{id;model;type="EntityType";Name;ReferenceMode;PlayedRoles=[];PreferredIdentifier="";_Shadows;_RelName=null;_Atom="";XML="";constructor(n,entity){var d=entity.d3object.datum();this.id=`object-${n}-`+entity.model,this.model=entity.model,this.Name=d.name,this.ReferenceMode=d.refmode,this.PlayedRoles=entity.plays_roles(),this._Shadows=[entity.id]}extend(entity){this._Shadows.push(entity.id),this.PlayedRoles.push.apply(this.PlayedRoles,entity.plays_roles())}toXML(){this.XML=`<orm:EntityType id="${this.id}" Name="${this.Name}" _ReferenceMode="${this.ReferenceMode}">
`,this.XML+=`    <orm:PlayedRoles>
`,this.PlayedRoles.map(e=>{this.XML+=`        <orm:Role ref="${e}" />
`}),this.XML+=`    </orm:PlayedRoles>
`,this.XML+=`    <orm:PreferredIdentifier ref="${this.PreferredIdentifier}" />
`,this.XML+="</orm:EntityType>"}},ormjs.ValueType=class{id;model;type="ValueType";Name;PlayedRoles=[];ConceptualDataType="";_Shadows;_RelName=null;_Atom="";XML="";constructor(n,value){var d=value.d3object.datum();this.id=`object-${n}-`+value.model,this.model=value.model,this.Name=d.name,this.PlayedRoles=value.plays_roles(),this._Shadows=[value.id]}extend(value){this._Shadows.push(value.id),this.PlayedRoles.push.apply(this.PlayedRoles,value.plays_roles())}toXML(){this.XML=`<orm:ValueType id="${this.id}" Name="${this.Name}">
`,this.XML+=`    <orm:PlayedRoles>
`,this.PlayedRoles.map(e=>{this.XML+=`        <orm:Role ref="${e}" />
`}),this.XML+=`    </orm:PlayedRoles>
`,this.XML+=`    <orm:ConceptualDataType id="${this.id}-cdt" ref="${this.ConceptualDataType}" />
`,this.XML+="</orm:ValueType>"}},ormjs.Role=class{id;model;Name;type="Role";IsMandatory=!1;Multiplicity="None";RolePlayer=null;_rboxID;_rolenum;_factID;XML="";constructor(n,rbox){this.model=rbox.model,this.id="role-"+n;var metamodel=ormjs.models[this.model].metamodel,d=rbox.d3object.datum();this.Name=d.name,this.IsMandatory=d.mandatory,this.Multiplicity=d.multiplicity,this.RolePlayer=metamodel.m2mm[d.entity],this._rboxID=rbox.id,this._rolenum=n}toXML(){this.XML=`<orm:Role id="${this.id}" _IsMandatory="${this.IsMandatory}" `,this.XML+=`_Multiplicity="${this.Multiplicity}" Name="${this.Name}">
`,this.XML+=`    <orm:RolePlayer ref="${this.RolePlayer}" />
`,this.XML+="</orm:Role>"}toFact(fact){this.id=this.id+"-"+fact.id,this.Multiplicity=fact._multmap[this.Multiplicity],this._factID=fact.id}},ormjs.Reading=class{id;model;type="Reading";Data=null;ExpandedData=[];_rbgID;_factID;_roID;_rnum;_ronum;_ReadingType=null;_RelData=[];_Statement=null;_RelStatement=[];_includedIDs=[];XML="";constructor(n,ro){this.id=ro._factID+"-reading-"+n.toString(),this.model=ro.model,this._rbgID=ro._rbgID,this._factID=ro._factID,this._roID=ro.id,this._rnum=n,this._ronum=ro._ronum}set_reading(readingtype,rolen=0){this._ReadingType=readingtype,"NaryForwardReading"==this._ReadingType?this.forward_reading():"MandatoryForwardReading"==this._ReadingType&&this.mandatory_reading(rolen)}toXML(){this.XML=`<orm:Reading id="${this.id}">
`,this.XML+=`    <orm:Data>${this.Data}</orm:Data>
`,this.XML+=`    <orm:ExpandedData>
`,this.ExpandedData.map(e=>{this.XML+=`        <orm:RoleText RoleIndex="${e.RoleIndex}" FollowingText="${e.FollowingText}" PrecedingText="${e.PrecedingText}" />
`}),this.XML+=`    </orm:ExpandedData>
`,this.XML+="</orm:Reading>"}set_rel_reading(){"NaryForwardReading"==this._ReadingType&&ormjs.GenerateRel.add_NaryForwardReading(this),"MandatoryForwardReading"==this._ReadingType&&ormjs.GenerateRel.add_MandatoryForwardReading(this)}forward_reading(){var metamodel=ormjs.models[this.model].metamodel,factroles=metamodel.Fact[this._factID].FactRoles,rs=metamodel.Fact[this._factID].ReadingOrder[this._ronum].RoleSequence,includedIDs=rs.map(e=>factroles[e]._rboxID),connIDs=(includedIDs.push(this._rbgID),rs.map(e=>{e=factroles[e].IsMandatory?null:ormjs.Graph.any_object(factroles[e]._rboxID).entity_connector();return e}).filter(v=>v)),connIDs=(includedIDs.push.apply(includedIDs,connIDs),ormjs.Reading.sequence_reading(rs,metamodel.Fact[this._factID]));this.Data=connIDs.data,this.ExpandedData=connIDs.expanded_data,this._ReadingType="NaryForwardReading",this._includedIDs=includedIDs}mandatory_reading(rolen){var includedIDs,metamodel=ormjs.models[this.model].metamodel,fwd_reading=metamodel.Fact[this._factID].ReadingOrder[this._ronum].Reading[0];"NaryForwardReading"!=!fwd_reading._ReadingType&&(includedIDs=[...fwd_reading._includedIDs],metamodel=metamodel.Fact[this._factID].FactRoles[rolen]._rboxID,includedIDs.push(ormjs.Graph.any_object(metamodel).entity_connector()),metamodel=`For every {${rolen}}, `+fwd_reading.Data,(fwd_reading=[...fwd_reading.ExpandedData]).splice(0,0,{RoleIndex:rolen,PrecedingText:"For every",FollowingText:""}),this.Data=metamodel,this.ExpandedData=fwd_reading,this._ReadingType="MandatoryForwardReading",this._includedIDs=includedIDs)}static sequence_reading(rs,fact){var factroles=fact.FactRoles,data=`{${rs[0]}} `+factroles[rs[0]].Name,expanded_data=[];if(expanded_data.push({RoleIndex:rs[0],FollowingText:factroles[rs[0]].Name,PrecedingText:""}),1<rs.length){0<factroles[rs[1]].Name.length&&(data+=" "+factroles[rs[1]].Name),data+=` {${rs[1]}}`,expanded_data.push({RoleIndex:rs[1],PrecedingText:factroles[rs[1]].Name,FollowingText:""});var n,rng=ormjs.GraphUtils.range(rs.length-2,2);for(n in rng)data+=` ${factroles[rs[rng[n]]].Name} {${rs[rng[n]].toString()}}`,expanded_data.push({RoleIndex:rs[rng[n]],PrecedingText:factroles[rs[rng[n]]].Name,FollowingText:""})}return{data:data,expanded_data:expanded_data}}},ormjs.ReadingOrder=class{id;model;type="ReadingOrder";Reading=[];RoleSequence=[];_rbgID;_factID;_ronum;_FirstEntity=null;_RelName=null;XML="";constructor(n,fact){this.id=fact.id+"-reading-order-"+n.toString(),this.model=fact.model,this._factID=fact.id,this._rbgID=fact._rbgID,this._ronum=n}set_sequence(direction){"forward"==direction&&this.forward()}toXML(){var metamodel=ormjs.models[this.model].metamodel,t="    ",factroles=(this.XML=`<orm:ReadingOrder id="${this.id}">
`,this.XML+=`    <orm:Readings>
`,this.Reading.map(e=>{e.toXML();e=(e=(" "+e.XML).slice(1)).replaceAll(`
`,`
`+t.repeat(2));this.XML+=""+t.repeat(2)+e+`
`}),this.XML+=`    </orm:Readings>
`,metamodel.Fact[this._factID].FactRoles);this.XML+=`    <orm:RoleSequence>
`,this.RoleSequence.map(e=>{this.XML+=`        <orm:Role ref="${factroles[e].id}" />
`}),this.XML+=`    </orm:RoleSequence>
`,this.XML+="</orm:ReadingOrder>"}set_relname(){this._RelName=reading_order_relname(this)}forward(){var n,rmand,factroles=ormjs.models[this.model].metamodel.Fact[this._factID].FactRoles,rnum=(this.RoleSequence=[...factroles.keys()],this._FirstEntity=factroles[0].RolePlayer,0),r=new ormjs.Reading(rnum,this);for(n in r.set_reading("NaryForwardReading"),this.Reading.push(r),rnum+=1,factroles)factroles[n].IsMandatory&&(rmand=new ormjs.Reading(rnum,this),this.Reading.push(rmand),rmand.set_reading("MandatoryForwardReading",n),rnum+=1)}},ormjs.Fact=class{id;model;type="FactType";FactRoles=[];ReadingOrder=[];InternalConstraints=[];_Name;_rbgID;_Shadows;_multmap;XML="";constructor(n,rbgroup){this.id=`fact-${n}-`+rbgroup.model,this.model=rbgroup.model,this._rbgID=rbgroup.id,this.InternalConstraints=[],this._Name=rbgroup.d3object.datum().name,this._Shadows=[rbgroup.id],this.add_roles(rbgroup)}populate_shadows(){var metamodel=ormjs.models[this.model].metamodel,matchlist=metamodel.find_fact(this);if(0<matchlist.length)for(var n in matchlist){var rbgIDn=ormjs.GraphUtils.key_from_value(metamodel.m2mm,matchlist[n]);rbgIDn!=this._rbgID&&(metamodel.Fact[matchlist[n]]._Shadows.push(this._rbgID),this._Shadows.push(rbgIDn))}}populate_reading_orders(){var ro=new ormjs.ReadingOrder(0,this);this.ReadingOrder.push(ro),ro.set_sequence("forward")}toXML(){var t="    ";this.XML=`<orm:Fact id="${this.id}" _Name="${this._Name}">
`,this.XML+=`    <orm:FactRoles>
`,this.FactRoles.map(role=>{role.toXML();role=(role=(" "+role.XML).slice(1)).replaceAll(`
`,`
`+t.repeat(2));this.XML+=""+t.repeat(2)+role+`
`}),this.XML+=`    </orm:FactRoles>
`,this.XML+=`    <orm:ReadingOrders>
`,this.ReadingOrder.map(ro=>{ro.toXML();ro=(ro=(" "+ro.XML).slice(1)).replaceAll(`
`,`
`+t.repeat(2));this.XML+=""+t.repeat(2)+ro+`
`}),this.XML+=`    </orm:ReadingOrders>
`,this.XML+="</orm:Fact>"}add_roles(rbgroup){this.multiplicity(rbgroup);var n,boxes=[...rbgroup.d3object.datum().boxes],factroles=(rbgroup.d3object.datum().flipped&&boxes.reverse(),[]),roleboxes=ormjs.models[rbgroup.model].objects.rolebox;for(n in boxes)factroles[n]=new ormjs.Role(n,roleboxes[boxes[n]]),factroles[n].toFact(this);this.FactRoles=factroles}multiplicity(rbgroup){var n,mult_param=ormjs.Rolebox.multiplicity(),multmap={},multlist=(multmap[mult_param.one]="ExactlyOne",multmap[mult_param.many]="ZeroToMany",[]),boxes=rbgroup.d3object.datum().boxes,roleboxes=ormjs.models[rbgroup.model].objects.rolebox;for(n in boxes)multlist.push(roleboxes[boxes[n]].d3object.datum().multiplicity);multlist.includes(mult_param.many)?(multmap[mult_param.none]="ExactlyOne",multmap[mult_param.skip]="ExactlyOne"):(multmap[mult_param.none]="ZeroToMany",multmap[mult_param.skip]="ZeroToMany"),this._multmap=multmap}fill_readings(){var n,metamodel=ormjs.models[this.model].metamodel,role_map={data:{},rel:{},atom:{},atom_key:{}},objlist=[];for(n in this.FactRoles){var key=`{${n}}`,akey=`{a${n}}`,objID=this.FactRoles[n].RolePlayer;null!=objID&&(role_map.data[key]=metamodel.Object[objID].Name,role_map.rel[key]=metamodel.Object[objID]._RelName,role_map.atom[key]=metamodel.Object[objID]._Atom,role_map.atom_key[key]=akey,objlist.push.apply(objlist,metamodel.Object[objID]._Shadows))}this.ReadingOrder.map(ro=>{ro.Reading.map(reading=>{var key,data=reading.Data,reldata=[...reading._RelData];for(key in role_map.data)data=data.replaceAll(key,role_map.data[key]),reldata=(reldata=reldata.map(e=>e.replaceAll(key,role_map.rel[key]))).map(e=>e.replaceAll(role_map.atom_key[key],role_map.atom[key]));data.includes("{")?(data=null,reldata=[]):(metamodel.relIDs.push.apply(metamodel.relIDs,reading._includedIDs),metamodel.relIDs.push.apply(metamodel.relIDs,objlist)),reading._Statement=data,reading._RelStatement=reldata})})}},ormjs.Metamodel=class{id;model;Object={};Fact={};SubtypeFact={};Constraint={};relIDs=[];XML="";m2mm={};constructor(model){this.model=model,this.id="meta-"+model}populate(){var objects=ormjs.models[this.model].objects;this.add_objects(objects.entity,"EntityType"),this.add_objects(objects.value,"ValueType"),this.add_facts(objects.predicate),this.toXML()}add_entity(n,entity){n=new ormjs.EntityType(n,entity);this.m2mm[entity.id]=n.id,this.Object[n.id]=n}add_value(n,value){n=new ormjs.ValueType(n,value);this.m2mm[value.id]=n.id,this.Object[n.id]=n}add_fact(n,rbgroup){n=new ormjs.Fact(n,rbgroup);this.m2mm[rbgroup.id]=n.id,n.FactRoles.map(role=>{this.m2mm[role._rboxID]=role.id}),(this.Fact[n.id]=n).populate_shadows(),n.populate_reading_orders()}add_objects(objects,kind="EntityType"){var objID,n=Object.keys(this.Object).length;for(objID in objects){var matchID=this.find_object(objects[objID]);matchID?(this.m2mm[objID]=matchID,this.Object[matchID].extend(objects[objID])):("EntityType"==kind?this.add_entity(n,objects[objID]):this.add_value(n,objects[objID]),n+=1)}}add_facts(predicates){var rbgID,objID,n=0;for(rbgID in predicates)this.add_fact(n,predicates[rbgID]),n+=1;for(objID in this.Object)this.Object[objID].PlayedRoles=this.Object[objID].PlayedRoles.map(e=>this.m2mm[e])}find_object(object){var mmID,d=object.d3object.datum(),kindmatch={entity:"EntityType",value:"ValueType"};for(mmID in this.Object)if(this.Object[mmID].Name==d.name&&this.Object[mmID].type==kindmatch[d.kind])return mmID;return!1}toXML(){var objID,factID,xml,t="    ";for(objID in this.XML=`<orm:ORMModel>
`,this.XML+=`    <orm:Objects>
`,this.Object)this.Object[objID].toXML(),xml=(xml=(" "+this.Object[objID].XML).slice(1)).replaceAll(`
`,`
`+t.repeat(2)),this.XML+=`        ${xml}
`;for(factID in this.XML+=`    </orm:Objects>
`,this.XML+=`    <orm:Facts>
`,this.Fact)this.Fact[factID].toXML(),xml=(xml=(" "+this.Fact[factID].XML).slice(1)).replaceAll(`
`,`
`+t.repeat(2)),this.XML+=`        ${xml}
`;this.XML+=`    </orm:Facts>
`,this.XML+=`</orm:ORMModel>
`}display_xml(){var xml,model=ormjs.models[this.model];model.generate_xml&&(xml=(xml=(" "+this.XML).slice(1)).replaceAll("<","&lt;").replaceAll(">","&gt;"),d3.select("#"+model.xml_target).html(`<pre><code class="language-xml">${xml}</code></pre>`))}find_fact(fact){var factID,shortFormat=ormjs.display.shortFormat,graphFormat=ormjs.display.graphFormat,rbg_factroles=fact.FactRoles,factlist=[],matchlist=["Multiplicity","RolePlayer","Name"];for(factID in shortFormat&&graphFormat?matchlist=["Multiplicity","RolePlayer"]:shortFormat&&!graphFormat&&(matchlist=["Multiplicity","Name"]),1==rbg_factroles.length&&matchlist.push("Name"),this.Fact){var factroles=this.Fact[factID].FactRoles,match=!0;if(Object.keys(factroles).length==Object.keys(rbg_factroles).length)for(var n in factroles)matchlist.map(attr=>{factroles[n][attr]!=rbg_factroles[n][attr]&&(match=!1)});else match=!(this.Fact[factID]._Name!=fact._Name||!matchlist.includes("Name"));match&&factID!=fact.id&&factlist.push(factID)}return factlist}};